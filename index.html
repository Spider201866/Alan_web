<!-- WJW 28/03/2024 -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Alan</title>

    <script type="module">
      import { faviconAndMetaSetup } from './faviconAndMeta.js';
      faviconAndMetaSetup();
    </script>

    <link rel="stylesheet" href="styles.css">

    <script type="text/javascript">
      function checkPassword() {
        var encodedPassword = "NjYyMDIz";
        var passwordEntered = prompt("Enter password:", "");
        var encodedInput = btoa(passwordEntered);
        if (encodedInput === encodedPassword) {
          document.getElementById("mainContent").classList.remove("hidden");
        } else {
          document.body.innerHTML = "Access denied.";
        }
      }
      function closeContent() {
        document.getElementById("mainContent").classList.add("hidden");
      }
      window.onload = function () {
        document.getElementById("mainContent").classList.add("hidden");
        checkPassword();
      };
    </script>
  </head>

  <body>
    <div id="mainContent" class="hidden">
      <button class="close-button" onclick="closeContent()">X</button>
      <p>
        <strong>*Experimental*</strong> AI assistant for students and those who
        only occasionally see eye or ear cases. Concise and keeps on topic. Give
        symptoms & signs clearly for best results, avoid identifying names or
        details, keep audio messages to &lt;30 sec. Good luck!
        <em>Arclight Project, University of St Andrews, UK. 2024</em>
      </p>
    </div>
    <div class="chatbot-header" style="background-color: black; color: black">
      <div class="chatbot-title">
        <span class="red">Al</span><span class="white">an</span>
      </div>
      <div
        class="chatbot-subtitle grey-text"
        style="font-style: italic; font-size: 11px"
      >
        Eyes & Ears
      </div>
      <div class="chatbot-subtitle" style="color: grey; padding-bottom: 20px">
        <span class="tooltip-item" title="Tell Alan about the problem & onset"
          >Good History</span
        >
        <span class="divider">|</span>
        <span
          class="tooltip-item"
          title="What you see&#10;Vision & Pupils&#10;Hearing"
          >Examine Well</span
        >
        <span class="divider">|</span>
        <span
          class="tooltip-item"
          title="Front of eye, fundal reflex, back of eye&#10;All around ear, canal, drum"
          >Use Arclight</span
        >
      </div>
    </div>
    <div class="chatbot-container">
      <flowise-fullchatbot></flowise-fullchatbot>
    </div>
    </div>
    <!-- Condition name displayed here -->
    <div class="detected-condition"></div>
    <img id="condition-image" src="" alt="Condition" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" />
    <p id="condition-description"></p> <!-- Add this line -->    
    <div class="chatbot-version grey-text" style="font-style: italic;">
        *Alan can make mistakes. Use clinical judgement. 28/03/24 wjw
        <br>
        <a href="https://medicine.st-andrews.ac.uk/arclight/" target="_blank" style="color: #0000FF;">
            https://medicine.st-andrews.ac.uk/arclight/
        </a>
    </div>    

    <script type="module">
      import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js";
      Chatbot.initFull({
        chatflowid: "f913ced7-8844-4393-82e7-de804bb2cb8e",
        apiHost: "https://flowiseai-railway-production-cfe0.up.railway.app",
        theme: {
          button: {
            backgroundColor: "#36454F",
            right: 30,
            bottom: 20,
            size: "medium",
            iconColor: "white",
            customIconSrc:
              "https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/google-messages.svg",
          },
          chatWindow: {
            welcomeMessage: false,
            backgroundColor: "#ffffff",
            height: "auto",
            width: "auto",
            fontSize: 14,
            poweredByTextColor: "#ffffff",
            botMessage: {
              backgroundColor: "#cccccc",
              textColor: "#000000",
              showAvatar: false,
              avatarSrc:
                "https://raw.githubusercontent.com/zahidkhawaja/langchain-chat-nextjs/main/public/parroticon.png",
            },
            userMessage: {
              backgroundColor: "#4d9afe",
              textColor: "#000000",
              showAvatar: false,
              avatarSrc:
                "https://raw.githubusercontent.com/zahidkhawaja/langchain-chat-nextjs/main/public/usericon.png",
            },
            textInput: {
              placeholder: "Message Alan...",
              backgroundColor: "#ffffff",
              textColor: "#303235",
              sendButtonColor: "#f73b3b",
            },
          },
        },
      });
    </script>

<script type="module">
  import { imagesWithText } from './imagesWithText.js'; // Make sure the path is correct

  document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
      const shadowHost = document.querySelector("flowise-fullchatbot");
      if (shadowHost) {
        const shadowRoot = shadowHost.shadowRoot;
        if (shadowRoot) {
          let messageBuffer = "";
          let lastCompleteMessage = "";

          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                  messageBuffer += node.textContent; // Accumulate text content

                  if (messageBuffer.includes("Good luck!")) {
                    lastCompleteMessage = messageBuffer.trim();
                    messageBuffer = ""; // Clear buffer after logging

                    const conditionMatch = lastCompleteMessage.match(/On balance, (.*?) is/);
                    if (conditionMatch && conditionMatch[1]) {
                      const condition = conditionMatch[1].replace(/ is$/, '').trim();

                      // Find the corresponding object in imagesWithText array
                      const matchingObject = imagesWithText.find(item => item.condition.toLowerCase() === condition.toLowerCase());
                      
                      if (matchingObject) {
                        // Update condition text
                        const conditionElement = document.querySelector('.detected-condition');
                        if (conditionElement) {
                          conditionElement.textContent = matchingObject.text;
                        }

                        // Update image
                        const conditionImage = document.getElementById('condition-image');
                        if (conditionImage) {
                          conditionImage.src = `./conditions/${matchingObject.imageName}`;
                          conditionImage.alt = matchingObject.condition;
                        }
                      }
                    }
                    lastCompleteMessage = ''; // Reset for next message
                  }
                }
              });
            });
          });

          observer.observe(shadowRoot, { childList: true, subtree: true });
        } else {
          console.error("Unable to access shadow root.");
        }
      } else {
        console.error("Shadow host not found.");
      }
    }, 1000);
  });
</script>

  </body>
</html>
