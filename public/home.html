<!DOCTYPE html>
<!-- Omit lang="en" so we don’t force English on refresh. -->
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Alan</title>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Favicons/meta if needed -->
  <script type="module">
    import { faviconAndMetaSetup } from './faviconAndMeta.js';
    faviconAndMetaSetup();
  </script>

  <!-- CSS + fonts -->
  <link rel="stylesheet" href="styles.css">
  <link rel="prefetch" href="atomsblue.jpg" as="image">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap"
    rel="stylesheet"
  >

  <!-- closer.js if you use it -->
  <script type="module" src="closer.js"></script>

  <!-- Inline styling if not in styles.css -->
  <style>

  </style>

  <!-- language.js -->
  <script type="module" src="language.js"></script>
</head>
<body>
  <div class="page-container">
    <!-- HEADER -->
    <div class="chatbot-header">
      <div class="flex-spacer"></div>
      <div>
        <div class="chatbot-title">
          <span class="red">Al</span><span class="white">an</span>
        </div>
        <div class="chatbot-subtitle">Eyes, Ears, Skin</div>
      </div>
      <div class="flex-spacer"></div>
    </div>

    <!-- Hamburger menu + side menu -->
    <div class="menu-icon"></div>
    <div class="side-menu">
      <div style="display: flex; margin-bottom: 10px;">
        <button id="instructions-button" class="button red pulse">How to use</button>
      </div>
      <div style="display: flex; margin-bottom: 10px;">
        <button
          id="eye-button"
          class="button"
          style="margin-right: 10px; background-color: rgb(134, 162, 255); border: 2px solid black; color: black;"
          onclick="window.location.href='eye.html';"
        >
          Eye
        </button>
        <button
          id="ear-button"
          class="button"
          style="margin-right: 10px; background-color: rgb(133, 255, 133); border: 2px solid black; color: black;"
          onclick="window.location.href='ear.html';"
        >
          Ear
        </button>
        <button
          id="skin-button"
          class="button"
          style="background-color: #efafff; border: 2px solid black; color: black;"
          onclick="window.location.href='skin.html';"
        >
          Skin
        </button>
      </div>

      <div style="display: flex; margin-bottom: 10px; align-items: center;">
        <a
          href="https://www.youtube.com/@arclightproject"
          style="text-decoration: none;"
        >
          <button
            id="videos-button"
            class="button grey"
            style="margin-right: 10px;"
          >
            Videos
          </button>
        </a>
        <button
          id="atoms-button"
          class="button grey"
          style="margin-right: 10px;"
          onclick="window.location.href='atoms.html';"
        >
          Atoms
        </button>
        <button
          id="tools-button"
          class="button grey"
          style="margin-right: 10px;"
        >
          Tools
        </button>

        <!-- Language button / dropdown -->
        <div style="position: relative;">
          <button
            class="button grey"
            id="language-button"
            style="
              background: url('lang.jpg') no-repeat center center;
              background-size: cover;
              border: 2px solid #3e3e3e;
              width: 32px;
              height: 32px;
            "
          ></button>
          <div
            id="language-dropdown"
            style="
              display: none;
              position: absolute;
              top: 40px;
              left: 50%;
              transform: translateX(-50%);
              background: #fff;
              border: 1px solid #ccc;
              z-index: 9999;
              min-width: 220px;
              white-space: nowrap;
              max-height: 350px;
              overflow-y: auto;
              font-size: 14px;
              line-height: 1.2;
            "
          >
            <ul style="margin: 0; padding: 0; list-style: none;">
              <li data-value="en" style="padding: 6px; cursor: pointer;"><strong>English</strong> (English)</li>
              <li data-value="zh" style="padding: 6px; cursor: pointer;"><strong>中文</strong> (Chinese)</li>
              <li data-value="hi" style="padding: 6px; cursor: pointer;"><strong>हिन्दी</strong> (Hindi)</li>
              <li data-value="es" style="padding: 6px; cursor: pointer;"><strong>Español</strong> (Spanish)</li>
              <li data-value="ar" style="padding: 6px; cursor: pointer;"><strong>العربية</strong> (Arabic)</li>
              <li data-value="fr" style="padding: 6px; cursor: pointer;"><strong>Français</strong> (French)</li>
              <li data-value="bn" style="padding: 6px; cursor: pointer;"><strong>বাংলা</strong> (Bangla)</li>
              <li data-value="pt" style="padding: 6px; cursor: pointer;"><strong>Português</strong> (Portuguese)</li>
              <li data-value="id" style="padding: 6px; cursor: pointer;"><strong>Bahasa Indonesia</strong> (Indonesian)</li>
              <li data-value="sw" style="padding: 6px; cursor: pointer;"><strong>Kiswahili</strong> (Swahili)</li>
              <li data-value="ur" style="padding: 6px; cursor: pointer;"><strong>اردو</strong> (Urdu)</li>
              <li data-value="fa" style="padding: 6px; cursor: pointer;"><strong>فارسی</strong> (Persian)</li>
              <li data-value="ln" style="padding: 6px; cursor: pointer;"><strong>Lingala</strong> (Lingala)</li>
              <li data-value="ha" style="padding: 6px; cursor: pointer;"><strong>Hausa</strong> (Hausa)</li>
              <li data-value="yo" style="padding: 6px; cursor: pointer;"><strong>Yorùbá</strong> (Yoruba)</li>
              <li data-value="ig" style="padding: 6px; cursor: pointer;"><strong>Igbo</strong> (Igbo)</li>
              <li data-value="zu" style="padding: 6px; cursor: pointer;"><strong>Zulu</strong> (Zulu)</li>
              <li data-value="am" style="padding: 6px; cursor: pointer;"><strong>አማርኛ</strong> (Amharic)</li>
              <li data-value="sn" style="padding: 6px; cursor: pointer;"><strong>chiShona</strong> (Shona)</li>
              <li data-value="rw" style="padding: 6px; cursor: pointer;"><strong>Ikinyarwanda</strong> (Kinyarwanda)</li>
              <li data-value="ny" style="padding: 6px; cursor: pointer;"><strong>Chichewa</strong> (Chichewa)</li>
              <li data-value="cy" style="padding: 6px; cursor: pointer;"><strong>Cymraeg</strong> (Welsh)</li>
            </ul>
          </div>
        </div>
      </div>

      <div style="display: flex; margin-bottom: 10px;">
        <a
          href="https://arclightprojectshop.co.uk/"
          style="text-decoration: none;"
        >
          <button
            id="arclight-project-button"
            class="button grey"
            style="margin-right: 10px;"
          >
            Arclight Project
          </button>
        </a>
        <button
          id="links-button"
          class="button grey"
          style="margin-right: 10px;"
          onclick="window.location.href='weblinks.html';"
        >
          Links
        </button>
        <button
          id="about-button"
          class="button grey"
          onclick="location.href='aboutalan.html';"
        >
          About
        </button>
      </div>

      <!-- Hidden chat links if needed -->
      <div style="display: none; flex-direction: column; width: 100%; margin-top: 20px;">
        <a href="#" data-chat-id="chat1" class="chat-link">Chat 1</a>
        <a href="#" data-chat-id="chat2" class="chat-link">Chat 2</a>
        <!-- etc. -->
      </div>
    </div><!-- end side-menu -->

    <!-- MAIN CONTENT -->
    <div class="content-wrapper" style="display: flex; flex-direction: column; justify-content: flex-start; min-height: 20vh; font-weight: bold;">
      <div
        class="logo-and-text-container"
        style="text-align: center; line-height: 1.0; padding-top: 20px;"
      >
        <p
          id="additional-text"
          class="grey-text"
          style="font-size: 15px; color: grey; margin-top: 0px;"
        >
          <span id="good-history">Good History</span> |
          <span id="examine-well">Examine Well</span> |
          <span id="use-arclight">Use Arclight</span>
        </p>
        <p
          id="sub-text"
          class="centered-content"
          style="font-size: 16px; color: black; font-weight: 900; padding-bottom: 5px;"
        ></p>
      </div>
      <div class="animation-container" id="animationContainer">
        <img
          src="./eyeor.gif"
          alt="Eyeor Animation"
          style="opacity: 0; transition: opacity 2s;"
        >
      </div>
    </div>

    <object
      type="text/html"
      data="boxes.html"
      id="boxesFrame"
      style="width:100%; height:100px; overflow:auto; border:none;"
    ></object>

    <div class="main-wrapper">
      <!-- FLOWISE chatbot -->
      <div class="chatbot-container">
        <flowise-fullchatbot></flowise-fullchatbot>
      </div>

<!-- somewhere in home.html, the container: -->
<div id="muted-buttons"></div>

<script>
  function fetchMutedSnippet() {
    return fetch('muted.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('muted-buttons').innerHTML = html;
        
        // Now that #images, #refer, #screenshot are in the DOM:
        initMutedButtons(); // from muted.js

        // Then do language if you like:
        const storedLang = localStorage.getItem('preferredLanguage') || 'en';
        updateMutedButtons(storedLang);
      })
      .catch(err => console.error('Error:', err));
  }

  document.addEventListener('DOMContentLoaded', () => {
    fetchMutedSnippet();
  });

  window.addEventListener('pageshow', () => {
    fetchMutedSnippet();
  });
</script>

<!-- Then ensure you include muted.js below (non-module) so it is accessible -->
<script src="muted.js"></script>


      <!-- Condition placeholders -->
      <div class="detected-condition"></div>
      <img id="condition-image" alt="" style="max-width: 100%; height: auto;" />
      <p id="condition-description"></p>
    </div><!-- end main-wrapper -->

    <footer class="chatbot-version">
      Alan can make mistakes, double check everything
    </footer>
  </div><!-- end .page-container -->

  <!-- POPUP + GEOLOCATION -->
  <div id="popup">
    <span class="popup-close" onclick="closePopup()">&times;</span>
    <div class="popup-content" id="popup-content"></div>

    <div style="text-align: center; margin-top: 10px; position: relative;">
      <button id="geolocation-button" class="button grey" style="font-size: 14px;">Check Location</button>
      <button 
        id="geo-info-button"
        style="
          background-color: #fff;
          color: #000;
          border: 1px solid #000;
          border-radius: 8px;
          padding: 4px 8px;
          cursor: pointer;
          font-size: 14px;
        "
      >
        i
      </button>
      <p
        id="location-info"
        style="display:none; margin-top: 5px; font-size:12px;"
      ></p>
      <div 
        id="geo-info-popup" 
        style="
          display: none;
          position: absolute;
          left: 50%;
          top: 120%;
          transform: translateX(-50%);
          width: 250px;
          max-width: none;
          background: #fefefe;
          border: 1px solid #000;
          padding: 10px;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        "
      >
        <p id="geoInfoText" style="font-size: 14px; margin: 0;">
          Additional info...
        </p>
      </div>
    </div>
  </div>

  <!-- SINGLE SCRIPT BLOCK -->
  <script type="module">
    import { translations } from './language.js';
    import { faviconAndMetaSetup } from './faviconAndMeta.js';
    import './closer.js';
    import './listener-module.js';

    // Re-run favicon if needed
    faviconAndMetaSetup();

    // Grab references
    const menuIcon = document.querySelector('.menu-icon');
    const sideMenu = document.querySelector('.side-menu');
    const instructionsButton = document.getElementById('instructions-button');
    const languageButton = document.getElementById('language-button');
    const languageDropdown = document.getElementById('language-dropdown');
    const conditionImage = document.getElementById('condition-image');
    const popup = document.getElementById('popup');
    const popupClose = document.querySelector('.popup-close');
    const chatbotVersion = document.querySelector('.chatbot-version');
    const boxesFrameEl = document.getElementById('boxesFrame');

    // Side menu resets on pageshow
    window.addEventListener('pageshow', () => {
      sideMenu.style.left = '-370px';
      menuIcon.classList.remove('open');
      selectAgentAndFetch();
      pushLocalStorageToServer();
    });

    // If user re-focuses tab, we push again
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        pushLocalStorageToServer();
      }
    });

    // If the page was loaded from back/forward cache:
    window.addEventListener('pageshow', (event) => {
      if (event.persisted) {
        // You can re-fetch snippet or do something
        fetchMutedSnippet();
      }
    });

    // DOMContentLoaded
    document.addEventListener('DOMContentLoaded', main);

    // MAIN function
    function main() {
      const storedLang = localStorage.getItem('preferredLanguage') || 'en';
      // The “very first fix” approach: do both
      updateLanguageDisplays(storedLang);
      updateMutedButtons(storedLang);

      setupMenuIcon();
      setupInstructionsButton();
      setupNameIcon();
      showGreeting();
      setupGeolocationButton();

      // If instructions clicked before
      if (localStorage.getItem('instructionsClicked') === 'true') {
        updateButtonStyle(instructionsButton);
      }

      if (conditionImage) {
        conditionImage.addEventListener('click', () => toggleZoom(conditionImage));
      } 
    }

    /* ================== LANGUAGE DROPDOWN =================== */
    languageButton.addEventListener('click', () => {
      languageDropdown.style.display = (languageDropdown.style.display === 'none') ? 'block' : 'none';
    });
    languageDropdown.querySelectorAll('li').forEach(item => {
      item.addEventListener('click', () => {
        const chosenLang = item.getAttribute('data-value');
        localStorage.setItem('preferredLanguage', chosenLang);
        updateLanguageDisplays(chosenLang);
        updateMutedButtons(chosenLang); // Important line
        languageDropdown.style.display = 'none';
      });
    });

    /* ================== MENU ICON =================== */
    function setupMenuIcon() {
      menuIcon.addEventListener('click', function() {
        this.classList.toggle('open');
        sideMenu.style.left = (sideMenu.style.left === '0px') ? '-370px' : '0px';
      });
    }

    /* ================== INSTRUCTIONS =================== */
    function setupInstructionsButton() {
      instructionsButton.addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.setItem('instructionsClicked', 'true');
        updateButtonStyle(this);
        setTimeout(() => {
          window.location.href = 'instructions.html';
        }, 300);
      });
    }
    function updateButtonStyle(button) {
      button.classList.remove('pulse');
      button.style.backgroundColor = 'grey';
      button.style.color = 'white';
    }

/* =====================================
   NAME ICON & POPUP SETUP
===================================== */
function setupNameIcon() {
  const storedName = localStorage.getItem('name') || 'User';
  const initialLetter = storedName.charAt(0).toUpperCase();

  // Create the small circle icon showing the user’s initial
  const nameIcon = document.createElement('div');
  nameIcon.className = 'name-icon';
  nameIcon.textContent = initialLetter;
  document.querySelector('.chatbot-header').appendChild(nameIcon);

  // Clicking the circle icon toggles the popup
  nameIcon.addEventListener('click', togglePopup);

  // The X in the top-right of the popup closes it
  popupClose.addEventListener('click', closePopup);
}

/* Toggle the popup on/off from the circle icon */
function togglePopup() {
  // If it is currently open, close it
  if (popup.style.right === '0px') {
    closePopup();
  } else {
    openPopup();
  }
}

function openPopup() {
  // Update the popup content every time it opens
  document.getElementById('popup-content').innerHTML = buildPopupContent();
  // Slide it in from the right
  popup.style.right = '0';
}

function closePopup() {
  // Slide it offscreen to the right
  popup.style.right = '-350px';
}


    /* ================== GREETING =================== */
    function showGreeting() {
      const name = localStorage.getItem('name');
      const subTextEl = document.getElementById('sub-text');
      if (name) {
        let firstName = name.split(' ')[0];
        // If East Asian surname logic, do it here if needed
        firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
        subTextEl.innerText = `${firstName}, what can I help with?`;
      } else {
        subTextEl.innerText = 'what can I help with?';
      }
    }

    /* ================== ZOOM IMAGE =================== */
    function toggleZoom(image) {
      if (image.style.height === '200px') {
        image.style.height = 'auto';
        image.style.maxWidth = 'none';
        image.style.cursor = 'zoom-out';
      } else {
        image.style.height = '200px';
        image.style.maxWidth = '100%';
        image.style.cursor = 'zoom-in';
      }
    }

    /* ================== POPUP CONTENT =================== */
    function buildPopupContent() {
      const lang = localStorage.getItem('preferredLanguage') || 'en';
      const name = localStorage.getItem('name') || 'Not set';
      const role = localStorage.getItem('selectedJobRole') || 'Not set';
      const experience = localStorage.getItem('selectedExperience') || 'Not set';
      const latitude = (parseFloat(localStorage.getItem('latitude')) || 0).toFixed(6);
      const longitude = (parseFloat(localStorage.getItem('longitude')) || 0).toFixed(6);
      const country = localStorage.getItem('country') || 'Not set';
      const iso2 = localStorage.getItem('iso2') || 'Not set';
      const classification = localStorage.getItem('classification') || 'Unknown';
      const roleClass = localStorage.getItem('roleClassification') || '';
      const area = localStorage.getItem('area') || 'Not set';
      const contactInfo = localStorage.getItem('contactInfo') || 'Not set';
      const selectedAgent = localStorage.getItem('selectedAgent') || 'Unknown';
      const focusRaw = localStorage.getItem('selectedFocus');
      let aims = 'Not set';
      if (focusRaw) {
        try {
          aims = JSON.parse(focusRaw).join(', ');
        } catch {
          aims = 'Not set';
        }
      }

      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const mins = String(now.getMinutes()).padStart(2, '0');
      const secs = String(now.getSeconds()).padStart(2, '0');
      const currDT = `${day}/${month}/${year}, ${hours}:${mins}:${secs}`;

      return `
        <h2>${translations[lang].userInfoTitle}</h2>
        <p><strong>${translations[lang].userName}:</strong> ${name}</p>
        <p><strong>${translations[lang].userContact}:</strong> ${contactInfo}</p>
        <p><strong>${translations[lang].userRole}:</strong> ${role}, ${experience}, ${roleClass}</p>
        <p><strong>${translations[lang].userAims}:</strong> ${aims}</p>
        <p id="latLongSection" style="color: grey;">
          <strong>${translations[lang].userLatLong}:</strong> ${latitude}, ${longitude}
        </p>
        <p id="areaSection" style="color: grey;">
          <strong>${translations[lang].userArea}:</strong> ${area}
        </p>
        <p id="countrySection" style="color: grey;">
          <strong>${translations[lang].userCountry}:</strong> ${country}, ${iso2}, ${classification}
        </p>
        <p style="color: grey;">
          <em><strong>${translations[lang].userVersion}:</strong> 1.0, ${selectedAgent}</em>
        </p>
        <p style="color: grey;">
          <em><strong>${translations[lang].userDateTime}:</strong> ${currDT}</em>
        </p>
      `;
    }

    /* ================== GEOLOCATION =================== */
    function setupGeolocationButton() {
      const geolocationButton = document.getElementById('geolocation-button');
      const locationInfo = document.getElementById('location-info');
      if (!geolocationButton) return;
      geolocationButton.addEventListener('click', () => {
        geolocationButton.style.backgroundColor = 'blue';
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const { latitude, longitude } = position.coords;
              localStorage.setItem('latitude', latitude);
              localStorage.setItem('longitude', longitude);
              locationInfo.innerText = `Updated location: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
              locationInfo.style.display = 'block';

              const areaName = await fetchAreaFromLatLong(latitude, longitude);
              localStorage.setItem('area', areaName);

              document.getElementById('popup-content').innerHTML = buildPopupContent();
              flashBlueOnUpdate();
              updateServerGeolocation();

              setTimeout(() => {
                geolocationButton.style.backgroundColor = 'grey';
              }, 2000);
            },
            (error) => {
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  locationInfo.innerText = 'User denied geolocation.';
                  break;
                case error.POSITION_UNAVAILABLE:
                  locationInfo.innerText = 'Location info unavailable.';
                  break;
                case error.TIMEOUT:
                  locationInfo.innerText = 'Request timed out.';
                  break;
                default:
                  locationInfo.innerText = 'An unknown error occurred.';
              }
              locationInfo.style.display = 'block';
              setTimeout(() => {
                geolocationButton.style.backgroundColor = 'grey';
              }, 2000);
            }
          );
        } else {
          locationInfo.innerText = 'Geolocation not supported.';
          locationInfo.style.display = 'block';
          setTimeout(() => {
            geolocationButton.style.backgroundColor = 'grey';
          }, 2000);
        }
      });
    }
    async function fetchAreaFromLatLong(lat, lng) {
      try {
        const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`;
        const resp = await fetch(url);
        const data = await resp.json();
        return data.city || data.locality || data.principalSubdivision || 'Unknown';
      } catch (err) {
        console.warn('Area fetch failed:', err);
        return 'Unknown';
      }
    }
    function flashBlueOnUpdate() {
      const latLongEl = document.getElementById('latLongSection');
      const areaEl = document.getElementById('areaSection');
      const countryEl = document.getElementById('countrySection');
      if (latLongEl) latLongEl.classList.add('flash-blue');
      if (areaEl) areaEl.classList.add('flash-blue');
      if (countryEl) countryEl.classList.add('flash-blue');
      setTimeout(() => {
        latLongEl?.classList.remove('flash-blue');
        areaEl?.classList.remove('flash-blue');
        countryEl?.classList.remove('flash-blue');
      }, 2000);
    }
    function updateServerGeolocation() {
      const sessionId = localStorage.getItem('sessionId') || `user-${Date.now()}`;
      const updatedData = {
        sessionId,
        latitude: localStorage.getItem('latitude'),
        longitude: localStorage.getItem('longitude'),
        area: localStorage.getItem('area'),
        name: localStorage.getItem('name'),
        role: localStorage.getItem('selectedJobRole'),
        experience: localStorage.getItem('selectedExperience'),
        focus: localStorage.getItem('selectedFocus')
          ? JSON.parse(localStorage.getItem('selectedFocus'))
          : [],
        country: localStorage.getItem('country'),
        iso2: localStorage.getItem('iso2'),
        classification: localStorage.getItem('classification'),
        roleClassification: localStorage.getItem('roleClassification'),
        contactInfo: localStorage.getItem('contactInfo'),
        version: localStorage.getItem('version') || '1.0',
        selectedAgent: localStorage.getItem('selectedAgent'),
        dateTime: new Date().toLocaleString('en-GB', { timeZone: 'UTC' })
      };
      fetch('https://alan.up.railway.app/record-info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      })
        .then(response => response.text())
        .then(data => {
          console.log('Server updated with geolocation data:', data);
        })
        .catch(err => {
          console.error('Error updating server:', err);
        });
    }

    /* ================== SELECT AGENT / FLOWISE CHATBOT =================== */
    function selectAgentAndFetch() {
      let chatbotModuleUrl = '';
      let selectedAgent = 'Unknown';
      const classification = localStorage.getItem('classification') || 'Unknown';
      const roleClass = localStorage.getItem('roleClassification') || '';

      // Example logic
      if (roleClass === ' (M)' && ['HI','MI'].includes(classification)) {
        chatbotModuleUrl = './agent1-chatbot-module.js';
        selectedAgent = 'Agent 1';
      } else if (roleClass === ' (M)' && ['LI','VLI'].includes(classification)) {
        chatbotModuleUrl = './agent3-chatbot-module.js';
        selectedAgent = 'Agent 3';
      } else if (roleClass === ' (P)' && ['HI','MI'].includes(classification)) {
        chatbotModuleUrl = './agent2-chatbot-module.js';
        selectedAgent = 'Agent 2';
      } else if (roleClass === ' (P)' && ['LI','VLI'].includes(classification)) {
        chatbotModuleUrl = './agent4-chatbot-module.js';
        selectedAgent = 'Agent 4';
      }
      localStorage.setItem('selectedAgent', selectedAgent);

      if (!localStorage.getItem('sessionId')) {
        localStorage.setItem('sessionId', Date.now().toString());
      }
      if (localStorage.getItem('infoRecorded') === 'true' && selectedAgent !== 'Unknown') {
        updateServerWithAgent(selectedAgent, localStorage.getItem('sessionId'));
      }

      if (chatbotModuleUrl) {
        import(chatbotModuleUrl)
          .then(mod => {
            const initChatbot = mod.initChatbot;
            if (typeof initChatbot === 'function') {
              initChatbot();
              console.log(`Loaded module: ${chatbotModuleUrl}`);
            } else {
              console.error('initChatbot function not found in agent script.');
            }
          })
          .catch(error => {
            console.error('Error loading chatbot module:', error);
          });
      } else {
        console.error('No matching chatbot module found.');
      }
    }
    function updateServerWithAgent(selectedAgent, sessionId) {
      const name = localStorage.getItem('name') || '';
      const role = localStorage.getItem('selectedJobRole') || '';
      const experience = localStorage.getItem('selectedExperience') || '';
      const focusRaw = localStorage.getItem('selectedFocus');
      let focusArray = [];
      if (focusRaw) {
        try {
          focusArray = JSON.parse(focusRaw);
        } catch {
          focusArray = [];
        }
      }
      const latitude = localStorage.getItem('latitude') || '';
      const longitude = localStorage.getItem('longitude') || '';
      const country = localStorage.getItem('country') || '';
      const iso2 = localStorage.getItem('iso2') || '';
      const classification = localStorage.getItem('classification') || '';
      const roleClassification = localStorage.getItem('roleClassification') || '';
      const area = localStorage.getItem('area') || '';
      const contactInfo = localStorage.getItem('contactInfo') || '';
      const version = localStorage.getItem('version') || '1.0';
      const dateTime = new Date().toLocaleString('en-GB', { timeZone: 'UTC' });

      const updatedUserInfo = {
        sessionId,
        name,
        role,
        experience,
        focus: focusArray,
        latitude,
        longitude,
        country,
        iso2,
        classification,
        roleClassification,
        area,
        contactInfo,
        version,
        dateTime,
        selectedAgent
      };
      fetch('https://alan.up.railway.app/record-info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedUserInfo)
      })
        .then(response => response.text())
        .then(data => {
          console.log('Updated Successfully:', data);
        })
        .catch(error => {
          console.error('Error updating data:', error);
        });
    }
    function pushLocalStorageToServer() {
      const selectedAgent = localStorage.getItem('selectedAgent') || 'Agent 1';
      const sessionId = localStorage.getItem('sessionId') || 'no-session-id';
      updateServerWithAgent(selectedAgent, sessionId);
    }

    // If boxesFrame is loaded, re-apply language
    if (boxesFrameEl) {
      boxesFrameEl.addEventListener('load', () => {
        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
        updateLanguageDisplays(currentLang);
      });
    }

    // The snippet’s function:
    window.updateMutedButtons = function(lang) {
      console.log('[updateMutedButtons] Called with:', lang);
      const imagesText = document.querySelector('#images .text-part');
      if (imagesText) {
        imagesText.textContent = translations[lang].images;
      }
      const helpText = document.querySelector('#help .text-part');
      if (helpText) {
        helpText.textContent = translations[lang].help;
      }
      const screenshotText = document.querySelector('#screenshot .text-part');
      if (screenshotText) {
        screenshotText.textContent = translations[lang].screenshot;
      }
      const referText = document.querySelector('#refer .text-part');
      if (referText) {
        referText.textContent = translations[lang].refer;
      }
      const referPopup = document.getElementById('refer-popup');
      if (referPopup) {
        referPopup.textContent = translations[lang].comingSoon;
      }
    };

    // The big function that updates the page text
// The big function that updates the page text
function updateLanguageDisplays(lang) {
  // 1) Main page subtitles & disclaimers
  document.querySelector('.chatbot-subtitle').textContent = translations[lang].eyesEars;
  document.getElementById('good-history').textContent = translations[lang].goodHistory;
  document.getElementById('examine-well').textContent = translations[lang].examineWell;
  document.getElementById('use-arclight').textContent = translations[lang].useArclight;
  chatbotVersion.textContent = translations[lang].alanMistakes;

  // 2) Buttons (Instructions, Eye, Ear, Skin, Videos, etc.)
  document.getElementById('instructions-button').textContent = translations[lang].instructionsButton;
  document.getElementById('eye-button').textContent = translations[lang].eyeButton;
  document.getElementById('ear-button').textContent = translations[lang].earButton;
  document.getElementById('skin-button').textContent = translations[lang].skinButton;
  document.getElementById('videos-button').textContent = translations[lang].videosButton;
  document.getElementById('atoms-button').textContent = translations[lang].atomsButton;
  document.getElementById('tools-button').textContent = translations[lang].toolsButton;
  document.getElementById('arclight-project-button').textContent = translations[lang].arclightProjectButton;
  document.getElementById('links-button').textContent = translations[lang].linksButton;
  document.getElementById('about-button').textContent = translations[lang].aboutButton;

  // 3) If the user saved a name, update sub-text greeting
  const userName = localStorage.getItem('name') || '';
  if (userName) {
    let firstName = userName.split(' ')[0];
    firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
    document.getElementById('sub-text').textContent = `${firstName}, ${translations[lang].howCanIHelp}`;
  } else {
    document.getElementById('sub-text').textContent = translations[lang].howCanIHelp;
  }

  // 4) If boxesFrame is loaded, update Eye/Ear marquee lines
  if (boxesFrameEl && boxesFrameEl.contentDocument) {
    const boxesDoc = boxesFrameEl.contentDocument;

    // Update all Eye lines if e.g. eyeMarqueeLine1a is found
    if (boxesDoc.getElementById('eyeMarqueeLine1a')) {
      // EYE lines 1
      boxesDoc.getElementById('eyeMarqueeLine1a').textContent = translations[lang].eyeMarqueeLine1;
      boxesDoc.getElementById('eyeMarqueeLine1b').textContent = translations[lang].eyeMarqueeLine1;
      // EYE lines 2
      boxesDoc.getElementById('eyeMarqueeLine2a').textContent = translations[lang].eyeMarqueeLine2;
      boxesDoc.getElementById('eyeMarqueeLine2b').textContent = translations[lang].eyeMarqueeLine2;
      // EYE lines 3
      boxesDoc.getElementById('eyeMarqueeLine3a').textContent = translations[lang].eyeMarqueeLine3;
      boxesDoc.getElementById('eyeMarqueeLine3b').textContent = translations[lang].eyeMarqueeLine3;
      // EYE lines 4
      boxesDoc.getElementById('eyeMarqueeLine4a').textContent = translations[lang].eyeMarqueeLine4;
      boxesDoc.getElementById('eyeMarqueeLine4b').textContent = translations[lang].eyeMarqueeLine4;
      // EYE lines 5
      boxesDoc.getElementById('eyeMarqueeLine5a').textContent = translations[lang].eyeMarqueeLine5;
      boxesDoc.getElementById('eyeMarqueeLine5b').textContent = translations[lang].eyeMarqueeLine5;
      // EYE lines 6
      boxesDoc.getElementById('eyeMarqueeLine6a').textContent = translations[lang].eyeMarqueeLine6;
      boxesDoc.getElementById('eyeMarqueeLine6b').textContent = translations[lang].eyeMarqueeLine6;
      // EYE lines 7
      boxesDoc.getElementById('eyeMarqueeLine7a').textContent = translations[lang].eyeMarqueeLine7;
      boxesDoc.getElementById('eyeMarqueeLine7b').textContent = translations[lang].eyeMarqueeLine7;
    }

    // Update all Ear lines if e.g. earMarqueeLine1a is found
    if (boxesDoc.getElementById('earMarqueeLine1a')) {
      // EAR lines 1
      boxesDoc.getElementById('earMarqueeLine1a').textContent = translations[lang].earMarqueeLine1;
      boxesDoc.getElementById('earMarqueeLine1b').textContent = translations[lang].earMarqueeLine1;
      // EAR lines 2
      boxesDoc.getElementById('earMarqueeLine2a').textContent = translations[lang].earMarqueeLine2;
      boxesDoc.getElementById('earMarqueeLine2b').textContent = translations[lang].earMarqueeLine2;
      // EAR lines 3
      boxesDoc.getElementById('earMarqueeLine3a').textContent = translations[lang].earMarqueeLine3;
      boxesDoc.getElementById('earMarqueeLine3b').textContent = translations[lang].earMarqueeLine3;
      // EAR lines 4
      boxesDoc.getElementById('earMarqueeLine4a').textContent = translations[lang].earMarqueeLine4;
      boxesDoc.getElementById('earMarqueeLine4b').textContent = translations[lang].earMarqueeLine4;
      // EAR lines 5
      boxesDoc.getElementById('earMarqueeLine5a').textContent = translations[lang].earMarqueeLine5;
      boxesDoc.getElementById('earMarqueeLine5b').textContent = translations[lang].earMarqueeLine5;
      // EAR lines 6
      boxesDoc.getElementById('earMarqueeLine6a').textContent = translations[lang].earMarqueeLine6;
      boxesDoc.getElementById('earMarqueeLine6b').textContent = translations[lang].earMarqueeLine6;
      // EAR lines 7
      boxesDoc.getElementById('earMarqueeLine7a').textContent = translations[lang].earMarqueeLine7;
      boxesDoc.getElementById('earMarqueeLine7b').textContent = translations[lang].earMarqueeLine7;
    }
  }
} 

// Hides the boxesFrame object as soon as user clicks the chatbot container
document.addEventListener('DOMContentLoaded', () => {
  const chatbotContainer = document.querySelector('.chatbot-container');
  const boxesFrame = document.getElementById('boxesFrame');

  if (chatbotContainer && boxesFrame) {
    chatbotContainer.addEventListener('click', () => {
      boxesFrame.style.display = 'none';
    });
  }
});



    document.addEventListener('DOMContentLoaded', () => {

  const chatbotTitle = document.querySelector('.chatbot-title');
  if (chatbotTitle) {
    // Remove and re-add the class so it restarts each refresh
    chatbotTitle.classList.remove('flip-horizontally');
    void chatbotTitle.offsetWidth; // Force reflow so the animation restarts
    chatbotTitle.classList.add('flip-horizontally');
  }
});

      // Keep your code that forcibly reloads if the page is shown from cache:
  window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
      // We need this so your menu does not break
      window.location.reload();
    }
  });

  </script>

</body>
</html>
