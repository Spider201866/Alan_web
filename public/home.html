<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
    <title>Alan</title>

    <!-- If you have a faviconAndMetaSetup script -->
    <script type="module">
        import { faviconAndMetaSetup } from './faviconAndMeta.js';
        faviconAndMetaSetup();
    </script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <link rel="preload" href="atomsblue.jpg" as="image">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Font links -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Closer.js if needed -->
    <script type="module" src="closer.js"></script>

    <!-- Optional inline style for flash effect -->
    <style>
      /* The flash-blue class briefly highlights the background in light-blue */
      .flash-blue {
        background-color: #cde8ff;  /* light blue */
        transition: background-color 1s ease-out;
      }
    </style>
</head>

<body>
    <div id="mainContent" class="hidden"></div>

    <div class="chatbot-header">
        <div class="flex-spacer"></div>
        <div>
            <div class="chatbot-title">
                <span class="red">Al</span><span class="white">an</span>
            </div>
            <div class="chatbot-subtitle">Eyes, Ears, Skin</div>
        </div>
        <div class="flex-spacer"></div>
    </div>

    <div class="menu-icon"></div> <!-- 2 line Menu Icon -->
    
    <div class="side-menu" style="display: flex; flex-wrap: wrap; align-items: center;">
        <div style="display: flex; margin-bottom: 10px;">
            <div>
                <button id="instructions-button" class="button red pulse">Diagnose with Alan: How to use</button>
            </div>
        </div>

        <!-- Eye/Ear/Skin Buttons -->
        <div style="display: flex; margin-bottom: 10px;">
            <button class="button" style="margin-right: 10px; background-color: rgb(134, 162, 255);" onclick="window.location.href='eye.html';">
                Eye
            </button>
            <button class="button" style="margin-right: 10px; background-color: rgb(133, 255, 133);" onclick="window.location.href='ear.html';">
                Ear
            </button>
            <button class="button" style="background-color: #efafff;" onclick="window.location.href='skin.html';">
                Skin
            </button>
        </div>

        <!-- Videos/Atoms/Tools/Language -->
        <div style="display: flex; margin-bottom: 10px; align-items: center;">
            <a href="https://www.youtube.com/@arclightproject" style="text-decoration: none;">
                <button class="button grey" style="margin-right: 10px;">Videos</button>
            </a>
            <button class="button grey" style="margin-right: 10px;" onclick="window.location.href='atoms.html';">Atoms</button>
            <button class="button grey" style="margin-right: 10px;">Tools</button>
            <!-- Language Button & Dropdown -->
            <div style="position: relative;">
                <button class="button grey" id="language-button" 
                        style="background: url('lang.jpg') no-repeat center center; 
                               background-size: cover; 
                               width: 32px; 
                               height: 32px; 
                               border: none;">
                </button>
                <select id="language-dropdown" class="language-dropdown"
                        style="display: none; position: absolute; top: 40px; left: 0;">
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="es">Español</option>
                    <option value="pt">Português</option>
                    <option value="ar">العربية</option>
                    <option value="sw">Kiswahili</option>
                    <option value="cy">Cymraeg</option>
                    <option value="ny">Chichewa</option>
                    <option value="rw">Kinwanda</option>
                    <option value="lg">Luganda</option>
                </select>
            </div>
        </div>

        <!-- Arclight/Links/About -->
        <div style="display: flex; margin-bottom: 10px;">
            <a href="https://medicine.st-andrews.ac.uk/arclight/" style="text-decoration: none;">
                <button class="button grey" style="margin-right: 10px;">Arclight Project</button>
            </a>
            <button class="button grey" style="margin-right: 10px;" onclick="window.location.href='weblinks.html';">Links</button>
            <button class="button grey" onclick="location.href='aboutalan.html';">About</button>
        </div>

        <!-- Chat Links -->
        <div style="display: flex; flex-direction: column; width: 100%; margin-top: 20px;">
            <a href="#" data-chat-id="chat1" class="chat-link">Chat 1</a>
            <a href="#" data-chat-id="chat2" class="chat-link">Chat 2</a>
            <a href="#" data-chat-id="chat3" class="chat-link">Chat 3</a>
            <a href="#" data-chat-id="chat4" class="chat-link">Chat 4</a>
            <a href="#" data-chat-id="chat5" class="chat-link">Chat 5</a>
            <a href="#" data-chat-id="chat6" class="chat-link">Chat 6</a>
        </div>
    </div>

    <div class="content-wrapper" style="display: flex; flex-direction: column; justify-content: flex-start; min-height: 20vh; font-weight: bold;">
        <div class="logo-and-text-container" style="text-align: center; line-height: 1.0; padding-top: 20px;">
            <p id="additional-text" class="grey-text" style="font-size: 15px; color: grey; margin-top: 0px;">
                <span id="good-history">Good History</span>  |  
                <span id="examine-well">Examine Well</span>  |  
                <span id="use-arclight">Use Arclight</span>
            </p>
            <p id="sub-text" class="centered-content" style="font-size: 16px; color: black; font-weight: 900; padding-bottom: 5px;"></p>
        </div>
        <div class="animation-container" id="animationContainer">
            <img src="./eyeor.gif" alt="Eyeor Animation" style="opacity: 0; transition: opacity 2s;">
        </div>
    </div>

    <object type="text/html" data="boxes.html" id="boxesFrame" style="width:100%; height:100px; overflow:auto; border:none;"></object>

    <div class="chatbot-container">
        <flowise-fullchatbot></flowise-fullchatbot>
    </div>

    <div>
        <!-- Condition name displayed here -->
        <div class="detected-condition"></div>

        <!-- Thumbnail image with onclick functionality for zoom -->
        <img id="condition-image" alt="" style="max-width: 100%; height: 120px; display: block; margin: 0 auto; cursor: pointer;" />
        <p id="condition-description"></p>

        <!-- Disclaimer about Alan potentially making mistakes -->
        <div class="chatbot-version">
            Alan can make mistakes. Use clinical judgement. 1/25
        </div>
    </div>

    <!-- Popup for user info -->
    <div id="popup" class="popup">
        <span class="popup-close" onclick="closePopup()">&times;</span>
        <h2>User Info</h2>
        <div class="popup-content" id="popup-content"></div>

        <!-- GEOLOCATION BUTTON & FEEDBACK -->
        <div style="text-align: center; margin-top: 10px;">
            <button id="geolocation-button" class="button grey">Geolocation</button>
            <p id="location-info" style="display:none; margin-top: 5px; font-size: 12px;"></p>
        </div>
    </div>

    <!-- SINGLE SCRIPT BLOCK AT THE BOTTOM, TYPE=MODULE -->
    <script type="module">
    /*********************************************/
    /*         MODULE IMPORTS (IF ANY)           */
    /*********************************************/
    import { translations } from './language.js';
    import { faviconAndMetaSetup } from './faviconAndMeta.js';
    import './closer.js';
    import './listener-module.js'; // If needed

    // If needed, set up favicons again
    faviconAndMetaSetup();

    /*********************************************/
    /*       GLOBAL DOM REFERENCES               */
    /*********************************************/
    const menuIcon            = document.querySelector('.menu-icon');
    const sideMenu            = document.querySelector('.side-menu');
    const instructionsButton  = document.getElementById('instructions-button');
    const languageButton      = document.getElementById('language-button');
    const languageDropdown    = document.getElementById('language-dropdown');
    const conditionImage      = document.getElementById('condition-image');
    const popup               = document.getElementById('popup');
    const popupClose          = document.querySelector('.popup-close');
    const popupContent        = document.getElementById('popup-content');
    const additionalText      = document.getElementById('additional-text');
    const subText             = document.getElementById('sub-text');
    const chatbotVersion      = document.querySelector('.chatbot-version');
    const mainContent         = document.getElementById('mainContent');

    // For user info
    const storedName          = localStorage.getItem('name') || 'User';
    const classification      = localStorage.getItem('classification') || 'Unknown';
    const roleClassification  = localStorage.getItem('roleClassification') || '';
    const iso_a3              = localStorage.getItem('iso_a3') || 'Not set';

    /*********************************************/
    /*          HELPER FUNCTIONS                 */
    /*********************************************/

    // Zoom toggle for the condition image
    function toggleZoom(image) {
        if (image.style.height === '200px') {
            image.style.height    = 'auto';
            image.style.maxWidth  = 'none';
            image.style.cursor    = 'zoom-out';
        } else {
            image.style.height    = '200px';
            image.style.maxWidth  = '100%';
            image.style.cursor    = 'zoom-in';
        }
    }

    // Open/close the popup
    function openPopup() {
        popupContent.innerHTML = buildPopupContent();
        popup.style.right = '0';
        popup.style.display = 'block';
    }
    function closePopup() {
        popup.style.right = '-300px';
        setTimeout(() => {
            popup.style.display = 'none';
        }, 300);
    }

    // Build the dynamic content for the popup
    function buildPopupContent() {
        const name          = localStorage.getItem('name')              || 'Not set';
        const role          = localStorage.getItem('selectedJobRole')   || 'Not set';
        const experience    = localStorage.getItem('selectedExperience')|| 'Not set';
        const latitude      = (parseFloat(localStorage.getItem('latitude'))  || 0).toFixed(6);
        const longitude     = (parseFloat(localStorage.getItem('longitude')) || 0).toFixed(6);
        const country       = localStorage.getItem('country')           || 'Not set';
        const iso2          = localStorage.getItem('iso2')              || 'Not set';
        const classification= localStorage.getItem('classification')    || 'Unknown';
        const roleClass     = localStorage.getItem('roleClassification')|| '';
        const area          = localStorage.getItem('area')              || 'Not set';
        const contactInfo   = localStorage.getItem('contactInfo')       || 'Not set';
        const selectedAgent = localStorage.getItem('selectedAgent')     || 'Unknown';
        const focusRaw      = localStorage.getItem('selectedFocus');
        const aims          = focusRaw ? JSON.parse(focusRaw).join(', ') : 'Not set';

        // Current date/time
        const now    = new Date();
        const day    = String(now.getDate()).padStart(2, '0');
        const month  = String(now.getMonth() + 1).padStart(2, '0');
        const year   = now.getFullYear();
        const hours  = String(now.getHours()).padStart(2, '0');
        const mins   = String(now.getMinutes()).padStart(2, '0');
        const secs   = String(now.getSeconds()).padStart(2, '0');
        const currDT = `${day}/${month}/${year}, ${hours}:${mins}:${secs}`;

        // Add IDs to lat/long, area, country <p> for flash effect
        return `
          <p><strong>Name:</strong> ${name}</p>
          <p><strong>Contact:</strong> ${contactInfo}</p>
          <p><strong>Role:</strong> ${role}, ${experience}, ${roleClass}</p>
          <p><strong>Aims:</strong> ${aims}</p>
          <p id="latLongSection" style="color: grey;">
             <strong>Lat &amp; Long:</strong> ${latitude}, ${longitude}
          </p>
          <p id="areaSection" style="color: grey;">
             <strong>Area:</strong> ${area}
          </p>
          <p id="countrySection" style="color: grey;">
             <strong>Country:</strong> ${country}, ${iso2}, ${classification}
          </p>
          <p style="color: grey;">
             <em><strong>Version:</strong> 1.0, ${selectedAgent}</em>
          </p>
          <p style="color: grey;">
             <em><strong>Date &amp; Time:</strong> ${currDT}</em>
          </p>
        `;
    }

    // Simple function to highlight (flash) lat/long, area, and country
    function flashBlueOnUpdate() {
      const latLongEl  = document.getElementById('latLongSection');
      const areaEl     = document.getElementById('areaSection');
      const countryEl  = document.getElementById('countrySection');

      if (latLongEl)  latLongEl.classList.add('flash-blue');
      if (areaEl)     areaEl.classList.add('flash-blue');
      if (countryEl)  countryEl.classList.add('flash-blue');

      // Remove the highlight after ~2 seconds
      setTimeout(() => {
          if (latLongEl)  latLongEl.classList.remove('flash-blue');
          if (areaEl)     areaEl.classList.remove('flash-blue');
          if (countryEl)  countryEl.classList.remove('flash-blue');
      }, 2000);
    }

    // Basic check to see if a name part might be an East Asian surname
    function containsEastAsianSurname(nameParts) {
        // A short snippet from your bigger list for illustration
        const eastAsianSurnames = [
            // 200 Chinese surnames ordered by commonality
        'Li', 'Wang', 'Zhang', 'Liu', 'Chen', 'Yang', 'Huang', 'Zhao', 'Wu', 'Zhou',
        'Xu', 'Sun', 'Ma', 'Zhu', 'Hu', 'Guo', 'He', 'Gao', 'Lin', 'Luo',
        'Zheng', 'Liang', 'Song', 'Tang', 'Han', 'Feng', 'Yu', 'Dong', 'Xiao',
        'Cheng', 'Cao', 'Yuan', 'Deng', 'Xue', 'Fu', 'Shen', 'Peng', 'Lu', 'Jiang',
        'Cui', 'Wei', 'Kang', 'Qian', 'Yin', 'Hao', 'Fan', 'Bai', 'Tan', 'Meng',
        'Qin', 'Xiong', 'Shi', 'Shao', 'Mao', 'Pan', 'Tian', 'Dai', 'Fang', 'Qiu',
        'Ruan', 'Gong', 'Mo', 'Jin', 'Bian', 'Chang', 'Liao', 'Zhuo', 'Cen', 'Zuo',
        'Hong', 'Ming', 'Zhan', 'Yao', 'Yan', 'Shan', 'Chai', 'Ji', 'Gu', 'Lei',
        'Ding', 'Wan', 'Mei', 'Qi', 'Pei', 'Miao', 'Jing', 'Ge', 'Lai', 'You',
        'Bao', 'Fu', 'Mi', 'Duan', 'Kou', 'Ning', 'Pi', 'Shang', 'Xiang', 'Gong',
        'Qin', 'Lu', 'Xue', 'Zhu', 'Cao', 'Fu', 'Ji', 'Lei', 'Lai', 'Zhao',
        'Liao', 'Dong', 'Ruan', 'Liu', 'Ning', 'Qin', 'Pan', 'Ge', 'Jiang', 'Lu',
        'Deng', 'Xiao', 'Tian', 'Mo', 'Xu', 'Hu', 'Yan', 'Chai', 'Yuan', 'Zhao',
        'Huang', 'Bian', 'Qiu', 'Gu', 'Shang', 'Duan', 'Xue', 'Dong', 'Gong', 'Pei',
        // 120 Japanese surnames ordered by commonality
        'Sato', 'Suzuki', 'Takahashi', 'Tanaka', 'Watanabe', 'Ito', 'Yamamoto', 'Nakamura', 'Kobayashi', 'Kato',
        'Yoshida', 'Yamada', 'Sasaki', 'Yamaguchi', 'Matsumoto', 'Inoue', 'Kimura', 'Shimizu', 'Hayashi', 'Saito',
        'Sakamoto', 'Shibata', 'Yokoyama', 'Ueda', 'Mori', 'Endo', 'Fujita', 'Okada', 'Ishikawa', 'Nakajima',
        'Kaneko', 'Maeda', 'Harada', 'Iwasaki', 'Murakami', 'Otsuka', 'Tsuchiya', 'Miyazaki', 'Kojima', 'Kudo',
        'Sakai', 'Takeuchi', 'Ishii', 'Fukuda', 'Miyamoto', 'Ueno', 'Sugiyama', 'Hirano', 'Arai', 'Masuda',
        'Tamura', 'Oshima', 'Hara', 'Matsuda', 'Ono', 'Matsuoka', 'Ishida', 'Morita', 'Takagi', 'Yoshikawa',
        'Taniguchi', 'Takada', 'Fujimoto', 'Kinoshita', 'Matsuo', 'Oda', 'Shinoda', 'Sugawara', 'Kuroda', 'Ando',
        'Hattori', 'Nakano', 'Hosokawa', 'Miyahara', 'Shimada', 'Kawaguchi', 'Hamamoto', 'Yamashita', 'Okamura',
        'Higuchi', 'Nagano', 'Tsuda', 'Otsubo', 'Ishizuka', 'Seki', 'Kubo', 'Miyake', 'Mizuno', 'Nakamoto',
        'Nakao', 'Fukushima', 'Nakagawa', 'Kawai', 'Onishi', 'Koyama', 'Kitamura', 'Kuwahara', 'Hasegawa', 'Aoyama',
        'Matsushima', 'Toyoda', 'Arakawa', 'Kondo', 'Kitagawa', 'Miyata', 'Uchida', 'Komatsu', 'Nagata', 'Yasuda',
        'Oikawa', 'Kashiwagi', 'Higashi', 'Fukui', 'Kishimoto', 'Tsuchida', 'Hoshino', 'Nakano', 'Ueno', 'Sugiyama',
        // 120 Korean surnames ordered by commonality
        'Kim', 'Lee', 'Park', 'Choi', 'Jung', 'Kang', 'Cho', 'Yoon', 'Jang', 'Lim',
        'Shin', 'Yoo', 'Chang', 'Song', 'Hong', 'Hwang', 'An', 'Ko', 'Moon', 'Oh',
        'Kwon', 'Jeon', 'Han', 'Seo', 'Ha', 'Ryu', 'Joo', 'Nam', 'Shim', 'No',
        'Min', 'Na', 'Jee', 'Seok', 'Byun', 'Yim', 'Son', 'Cha', 'Ahn', 'Jin',
        'Chun', 'Huh', 'Noh', 'Baek', 'Jeong', 'Gu', 'Yang', 'Yu', 'Kwak', 'Bae',
        'Yun', 'Moon', 'Jung', 'Park', 'Ryu', 'Kwon', 'Choi', 'Yoo', 'Oh', 'Jung',
        'Kim', 'Kwon', 'Yim', 'Hong', 'Yoon', 'Cho', 'Na', 'Ryu', 'Han', 'Yim',
        'Yun', 'Kang', 'Shin', 'Yun', 'Jang', 'Yoo', 'Kim', 'Kwon', 'Jung', 'Park',
        'Seo', 'Yang', 'Yoon', 'Choi', 'Park', 'Ryu', 'Kwon', 'Hong', 'Kim', 'Moon',
        'Yim', 'Son', 'Kim', 'Lee', 'Shin', 'Park', 'Kim', 'Choi', 'Jung', 'Yoo'
        ];
        return nameParts.some(part => eastAsianSurnames.includes(part));
    }
    function updateLanguageDisplays(lang) {
        document.querySelector('.chatbot-subtitle').textContent = translations[lang].eyesEars;
        document.getElementById('good-history').textContent      = translations[lang].goodHistory;
        document.getElementById('examine-well').textContent      = translations[lang].examineWell;
        document.getElementById('use-arclight').textContent      = translations[lang].useArclight;
        chatbotVersion.textContent                               = translations[lang].alanMistakes;

        const name = localStorage.getItem('name') || '';
        if (name) {
            let firstName = name.split(' ')[0];
            firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
            document.getElementById('sub-text').textContent = `${firstName}, ${translations[lang].howCanIHelp}`;
        } else {
            document.getElementById('sub-text').textContent = translations[lang].howCanIHelp;
        }
    }

    // Style for instructions button
    function updateButtonStyle(button) {
        button.classList.remove('pulse');
        button.style.backgroundColor = 'grey';
        button.style.color = 'white';
    }

    /*********************************************/
    /*            MAIN LOGIC / INIT              */
    /*********************************************/
    document.addEventListener('DOMContentLoaded', main);

    function main() {
        console.log("DOMContentLoaded event fired");
        setupMenuIcon();
        setupLanguageButton();
        setupInstructionsButton();
        setupNameIcon();

        if (localStorage.getItem("instructionsClicked") === "true") {
            updateButtonStyle(instructionsButton);
        }

        showGreeting();
        conditionImage.addEventListener('click', () => toggleZoom(conditionImage));
        updateLanguageDisplays('en');
        selectAgentAndFetch();
        setupGeolocationButton();
    }

    // Setup menu icon click
    function setupMenuIcon() {
        menuIcon.addEventListener('click', function() {
            this.classList.toggle('open');
            sideMenu.style.left = (sideMenu.style.left === '0px' ? '-370px' : '0px');
        });
    }

    // Setup language button
    function setupLanguageButton() {
        languageButton.addEventListener('click', function() {
            languageDropdown.style.display = (languageDropdown.style.display === 'none' ? 'block' : 'none');
        });
        languageDropdown.addEventListener('change', function() {
            updateLanguageDisplays(this.value);
        });
    }

    // Instructions button
    function setupInstructionsButton() {
        instructionsButton.addEventListener("click", function(event) {
            event.preventDefault();
            localStorage.setItem("instructionsClicked", "true");
            updateButtonStyle(this);
            setTimeout(() => {
                window.location.href = 'instructions.html';
            }, 300);
        });
    }

    // User’s first initial icon
    function setupNameIcon() {
        const initialLetter = storedName.charAt(0).toUpperCase();
        const nameIcon      = document.createElement('div');
        nameIcon.className  = 'name-icon';
        nameIcon.textContent= initialLetter;

        document.querySelector('.chatbot-header').appendChild(nameIcon);

        nameIcon.addEventListener('click', () => {
            if (popup.style.display === 'block' && popup.style.right === '0px') {
                closePopup();
            } else {
                openPopup();
            }
        });
        popupClose.addEventListener('click', closePopup);
    }

    // Show greeting
    function showGreeting() {
        let name = localStorage.getItem('name');
        const subTextEl = document.getElementById('sub-text');

        if (name) {
            let nameParts = name.split(' ');
            let firstName = '';
            if (containsEastAsianSurname(nameParts)) {
                firstName = nameParts[nameParts.length - 1];
            } else {
                firstName = nameParts[0];
            }
            firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase();
            subTextEl.innerText = `${firstName}, what can I help with??`;
        } else {
            console.error('Name not found in local storage');
            subTextEl.innerText = 'what can I help with?';
        }
    }

    // **Reverse-Geocoding** to get area from lat/long (BigDataCloud example)
    async function fetchAreaFromLatLong(lat, lng) {
        try {
            const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`;
            const resp = await fetch(url);
            const data = await resp.json();
            // city, locality, principalSubdivision, etc.
            const cityName = data.city || data.locality || data.principalSubdivision || 'Unknown';
            return cityName;
        } catch (err) {
            console.warn('Area fetch failed:', err);
            return 'Unknown';
        }
    }

    // Geolocation button
    function setupGeolocationButton() {
        const geolocationButton = document.getElementById("geolocation-button");
        const locationInfo      = document.getElementById("location-info");

        if (!geolocationButton) return;

        geolocationButton.addEventListener("click", () => {
            // Turn button blue
            geolocationButton.style.backgroundColor = "blue";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;

                        // Overwrite lat/long
                        localStorage.setItem('latitude', latitude);
                        localStorage.setItem('longitude', longitude);

                        // Show updated location quickly
                        locationInfo.innerText = `Updated location: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                        locationInfo.style.display = "block";

                        // 1) Reverse-geocode to get "area"
                        const areaName = await fetchAreaFromLatLong(latitude, longitude);
                        localStorage.setItem('area', areaName);

                        // 2) Rebuild popup so lat/long + area are fresh
                        popupContent.innerHTML = buildPopupContent();

                        // 3) Now flash lat/long, area, country in blue
                        flashBlueOnUpdate();

                        // Revert button to grey after 2s
                        setTimeout(() => {
                            geolocationButton.style.backgroundColor = "grey";
                        }, 2000);
                    },
                    (error) => {
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                locationInfo.innerText = "User denied geolocation.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                locationInfo.innerText = "Location information unavailable.";
                                break;
                            case error.TIMEOUT:
                                locationInfo.innerText = "Request to get user location timed out.";
                                break;
                            default:
                                locationInfo.innerText = "An unknown error occurred.";
                        }
                        locationInfo.style.display = "block";

                        // Revert color after 2s
                        setTimeout(() => {
                            geolocationButton.style.backgroundColor = "grey";
                        }, 2000);
                    }
                );
            } else {
                locationInfo.innerText = "Geolocation not supported by this browser.";
                locationInfo.style.display = "block";

                setTimeout(() => {
                    geolocationButton.style.backgroundColor = "grey";
                }, 2000);
            }
        });
    }

    // Agent selection
    function selectAgentAndFetch() {
        let chatbotModuleUrl = '';
        let selectedAgent    = 'Unknown';

        const classification = localStorage.getItem('classification') || 'Unknown';
        const roleClass      = localStorage.getItem('roleClassification') || '';

        if (roleClass === ' (M)' && ['HI','MI'].includes(classification)) {
            chatbotModuleUrl = './agent1-chatbot-module.js';
            selectedAgent    = 'Agent 1';
        } else if (roleClass === ' (M)' && ['LI','VLI'].includes(classification)) {
            chatbotModuleUrl = './agent3-chatbot-module.js';
            selectedAgent    = 'Agent 3';
        } else if (roleClass === ' (P)' && ['HI','MI'].includes(classification)) {
            chatbotModuleUrl = './agent2-chatbot-module.js';
            selectedAgent    = 'Agent 2';
        } else if (roleClass === ' (P)' && ['LI','VLI'].includes(classification)) {
            chatbotModuleUrl = './agent4-chatbot-module.js';
            selectedAgent    = 'Agent 4';
        }

        localStorage.setItem('selectedAgent', selectedAgent);

        if (!localStorage.getItem('sessionId')) {
            localStorage.setItem('sessionId', Date.now().toString());
        }
        const sessionId = localStorage.getItem('sessionId');

        console.log('Classification:', classification);
        console.log('Role Classification:', roleClass);
        console.log('Selected Agent:', selectedAgent);

        if (localStorage.getItem('infoRecorded') === 'true' && selectedAgent !== 'Unknown') {
            updateServerWithAgent(selectedAgent, sessionId);
        }

        if (chatbotModuleUrl) {
            import(chatbotModuleUrl)
                .then(module => {
                    module.initChatbot();
                    console.log(`Loaded module: ${chatbotModuleUrl}`);
                })
                .catch(error => {
                    console.error('Error loading chatbot module:', error);
                });
        } else {
            console.error('No matching chatbot module found.');
        }
    }

    // Send updated user info to server
    function updateServerWithAgent(selectedAgent, sessionId) {
        const name               = localStorage.getItem('name');
        const role               = localStorage.getItem('selectedJobRole');
        const latitude           = localStorage.getItem('latitude');
        const longitude          = localStorage.getItem('longitude');
        const country            = localStorage.getItem('country');
        const iso2               = localStorage.getItem('iso_2');
        const classification     = localStorage.getItem('classification');
        const roleClassification = localStorage.getItem('roleClassification');
        const area               = localStorage.getItem('area');
        const contactInfo        = localStorage.getItem('contactInfo');
        const version            = '1.0';
        const dateTime           = new Date().toLocaleString('en-GB', { timeZone: 'UTC' });

        const updatedUserInfo = {
            name,
            role,
            latitude,
            longitude,
            country,
            iso_a3,
            classification,
            roleClassification,
            area,
            contactInfo,
            version,
            dateTime,
            selectedAgent,
            sessionId
        };

        fetch('https://alan.up.railway.app/record-info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedUserInfo)
        })
        .then(response => response.text())
        .then(data => {
            console.log('Updated Successfully:', data);
        })
        .catch(error => {
            console.error('Error updating data:', error);
        });
    }
    </script>
</body>
</html>
