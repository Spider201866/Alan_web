<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Alan Records</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      /* ... Your existing styles ... */

      /* Add a style for the active user box */
      #activeUserBox {
        border: 2px solid red;
        padding: 10px;
        margin: 20px 0;
      }
    </style>
  </head>

  <body>
    <!-- PAGE TITLE -->
    <h1><span class="bold">Al</span><span class="light">an</span> Records</h1>

    <!-- PASSWORD SCREEN -->
    <div class="password-screen" id="passwordScreen">
      <!-- Same as before -->
    </div>

    <!-- REFRESH ICON -->
    <div id="refreshContainer" class="hidden" style="text-align: center; margin-top: 20px">
      <span id="refreshIcon" class="refresh-icon">&#x21bb;</span>
    </div>

    <!-- CONTAINER -->
    <div class="container">
      <!-- 1) The red-outlined box for the active user -->
      <div id="activeUserBox" class="hidden"></div>

      <!-- 2) The records table area -->
      <div id="records" style="margin-top: 20px"></div>
    </div>

    <!-- MAP CONTAINER -->
    <div id="map" class="map-container"></div>

    <!-- LEAFLET SCRIPT -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- MAIN SCRIPT -->
    <script>
      /* Existing code: password handling, fetchRecords, showMap, etc. */

      // Overwrite or add a function to build the display:
      //   - The first record goes into a red box (#activeUserBox)
      //   - The remaining records go into the main table
      function buildDisplay(data) {
        if (!data.length) {
          // no records at all
          document.getElementById('activeUserBox').classList.add('hidden');
          recordsDiv.innerHTML = '<p>No records found.</p>';
          return;
        }

        // Show the "active" user in the red box
        const activeUser = data[0];
        showActiveUserBox(activeUser);

        // If there's only 1 record, there's nothing else to display in the table
        if (data.length === 1) {
          recordsDiv.innerHTML = '<p>No other records.</p>';
        } else {
          // For the rest, build a normal table
          const remaining = data.slice(1);
          buildRecordsTable(remaining);
        }
      }

      // Show the first record in the red-outlined box
      function showActiveUserBox(record) {
        const box = document.getElementById('activeUserBox');
        box.classList.remove('hidden');

        // Build a single-line or multi-line display of the record
        // For example, just show a summary:
        box.innerHTML = `
          <h2>Active User</h2>
          <p><strong>Name:</strong> ${record.name || ''}</p>
          <p><strong>Role:</strong> ${record.role || ''}</p>
          <p><strong>Experience:</strong> ${record.experience || ''}</p>
          <p><strong>DateTime:</strong> ${record.dateTime || ''}</p>
          <p><strong>Version & Agent:</strong> ${record.version || ''} ${record.selectedAgent || ''}</p>
          <button onclick="showMap(${parseFloat(record.latitude) || 0}, ${parseFloat(record.longitude) || 0})">
            Show Map
          </button>
        `;
      }

      // Build a normal table for the rest of the records
      function buildRecordsTable(data) {
        let table = `
          <table>
            <thead>
              <tr>
                <th>No.</th>
                <th>Name</th>
                <th>Role</th>
                <th>Experience</th>
                <th>Focus</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Country (ISO2) [Classification]</th>
                <th>Area</th>
                <th>Date & Time</th>
                <th>Version & Agent</th>
                <th>Refresh Count</th>
                <th>Map</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach((record, index) => {
          const focusStr = Array.isArray(record.focus) ? record.focus.join(', ') : record.focus || '';
          const countryDisplay = `${record.country || ''} (${record.iso2 || ''}) [${record.classification || ''}]`;
          const versionAgent = record.version ? `${record.version}, ${record.selectedAgent}` : `${record.selectedAgent}`;

          table += `
            <tr>
              <td>${index + 1}</td>
              <td>${record.name || ''}</td>
              <td>${record.role || ''}</td>
              <td>${record.experience || ''}</td>
              <td>${focusStr}</td>
              <td>${record.latitude || ''}</td>
              <td>${record.longitude || ''}</td>
              <td>${countryDisplay}</td>
              <td>${record.area || ''}</td>
              <td>${record.dateTime || ''}</td>
              <td>${versionAgent || ''}</td>
              <td>${record.refreshCount || 1}</td>
              <td>
                <button onclick="showMap(${parseFloat(record.latitude) || 0}, ${parseFloat(record.longitude) || 0})">
                  Show Map
                </button>
              </td>
            </tr>
          `;
        });

        table += '</tbody></table>';
        recordsDiv.innerHTML = table;
      }

      // Now, in your handleSubmit and fetchRecords, call buildDisplay(data) instead of buildRecordsTable(data)
      function handleSubmit() {
        const entered = passwordInput.value.trim();
        fetch('/fetch-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ password: entered }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('Invalid password');
            }
            currentPassword = entered;
            passwordScreen.classList.add('hidden');
            return response.json();
          })
          .then((data) => {
            // Use buildDisplay
            buildDisplay(data);
            refreshContainer.classList.remove('hidden');
          })
          .catch((err) => {
            showInvalidPassword();
          });
      }

      function fetchRecords(password) {
        fetch('/fetch-records', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Cache-Control': 'no-cache',
          },
          body: JSON.stringify({ password }),
        })
          .then((response) => {
            if (!response.ok) throw new Error('Invalid password');
            return response.json();
          })
          .then((data) => {
            // Use buildDisplay
            buildDisplay(data);
            refreshContainer.classList.remove('hidden');
          })
          .catch((err) => {
            alert(err.message);
          });
      }
    </script>
  </body>
</html>
