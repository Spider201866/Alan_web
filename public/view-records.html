<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alan Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    h1 {
      text-align: center;
      margin-top: 40px;
      font-size: 32px;
    }
    .container {
      padding: 0 20px;
    }
    /* Red box for the single “active” record */
    #activeRecordBox {
      border: 2px solid red;
      padding: 10px;
      margin: 20px 0;
      display: none; /* hidden until we have a record */
    }
    /* Table for additional records */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
    }
    /* Map container */
    #map {
      width: 100%;
      height: 600px;
      margin-top: 20px;
      display: none;
    }
    /* Refresh icon */
    .refresh-icon {
      cursor: pointer;
      font-size: 30px;
      display: inline-block;
      transition: transform 0.3s ease;
    }
    .refresh-icon:hover {
      transform: rotate(20deg);
    }
    .refresh-icon:active {
      transform: rotate(360deg);
    }
  </style>
</head>

<body>
  <h1>Alan Records</h1>

  <!-- Password Screen -->
  <div id="passwordScreen">
    <!-- same password input, button, etc. from your existing code -->
  </div>

  <!-- Refresh icon -->
  <div id="refreshContainer" style="text-align: center; margin-top: 20px; display: none;">
    <span id="refreshIcon" class="refresh-icon">&#x21bb;</span>
  </div>

  <div class="container">
    <!-- Red box for the single “active” record -->
    <div id="activeRecordBox"></div>

    <!-- Spacer or heading -->
    <h3 id="historicalHeading" style="display: none;">Historical Records</h3>
    <!-- Table for the rest of the records -->
    <div id="recordsTable"></div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map;
    let currentPassword = '';
    const passwordScreen   = document.getElementById('passwordScreen');
    const refreshContainer = document.getElementById('refreshContainer');
    const refreshIcon      = document.getElementById('refreshIcon');
    const activeRecordBox  = document.getElementById('activeRecordBox');
    const historicalHeading= document.getElementById('historicalHeading');
    const recordsTable     = document.getElementById('recordsTable');
    const mapContainer     = document.getElementById('map');

    // Example: password logic, handleSubmit, fetchRecords, etc.

    function handleSubmit() {
      // fetch('/fetch-records' with password, then display
      // on success:
      displayAllRecords(/* the JSON data from server */);
      refreshContainer.style.display = 'block';
    }

    // Called on refresh icon click
    function handleRefresh() {
      if (!currentPassword) {
        alert('No valid password found.');
        return;
      }
      // fetchRecords(currentPassword) -> displayAllRecords
    }

    function displayAllRecords(data) {
      // If no records
      if (!Array.isArray(data) || data.length === 0) {
        activeRecordBox.style.display = 'none';
        activeRecordBox.innerHTML = '';
        historicalHeading.style.display = 'none';
        recordsTable.innerHTML = '<p>No records found.</p>';
        return;
      }
      
      // 1) Show the first record in the red box
      const firstRec = data[0];
      showActiveRecordBox(firstRec);

      // 2) The rest go below
      const remaining = data.slice(1);
      if (remaining.length > 0) {
        historicalHeading.style.display = 'block';
        buildRecordsTable(remaining);
      } else {
        // If no historical records, hide heading
        historicalHeading.style.display = 'none';
        recordsTable.innerHTML = '';
      }
    }

    function showActiveRecordBox(record) {
      activeRecordBox.style.display = 'block';
      activeRecordBox.innerHTML = `
        <h2>Active Record</h2>
        <p><strong>Session ID:</strong> ${record.sessionId || ''}</p>
        <p><strong>Name:</strong> ${record.name || ''}</p>
        <p><strong>Role:</strong> ${record.role || ''}</p>
        <p><strong>Experience:</strong> ${record.experience || ''}</p>
        <p><strong>Focus:</strong> ${
          Array.isArray(record.focus) ? record.focus.join(', ') : record.focus || ''
        }</p>
        <p><strong>Contact:</strong> ${record.contactInfo || ''}</p>
        <p><strong>Latitude:</strong> ${record.latitude || ''}</p>
        <p><strong>Longitude:</strong> ${record.longitude || ''}</p>
        <p><strong>Country (ISO2) [Class]:</strong>
          ${(record.country || '')} (${record.iso2 || ''}) [${record.classification || ''}]
        </p>
        <p><strong>Area:</strong> ${record.area || ''}</p>
        <p><strong>Date & Time:</strong> ${record.dateTime || ''}</p>
        <p><strong>Version & Agent:</strong> ${record.version || ''}, ${(record.selectedAgent || '')}</p>
        <p><strong>Refresh Count:</strong> ${record.refreshCount || 1}</p>
        <button onclick="showMap(${parseFloat(record.latitude) || 0}, ${parseFloat(record.longitude) || 0})">
          Show Map
        </button>
      `;
    }

    function buildRecordsTable(records) {
      let html = `
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>Session ID</th>
              <th>Name</th>
              <th>Role</th>
              <th>Experience</th>
              <th>Focus</th>
              <th>Contact</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Country (ISO2) [Class]</th>
              <th>Area</th>
              <th>Date & Time</th>
              <th>Version & Agent</th>
              <th>Refresh Count</th>
              <th>Map</th>
            </tr>
          </thead>
          <tbody>
      `;

      records.forEach((rec, index) => {
        html += `
          <tr>
            <td>${index + 1}</td>
            <td>${rec.sessionId || ''}</td>
            <td>${rec.name || ''}</td>
            <td>${rec.role || ''}</td>
            <td>${rec.experience || ''}</td>
            <td>${
              Array.isArray(rec.focus) ? rec.focus.join(', ') : rec.focus || ''
            }</td>
            <td>${rec.contactInfo || ''}</td>
            <td>${rec.latitude || ''}</td>
            <td>${rec.longitude || ''}</td>
            <td>
              ${(rec.country || '')} (${rec.iso2 || ''})
              [${rec.classification || ''}]
            </td>
            <td>${rec.area || ''}</td>
            <td>${rec.dateTime || ''}</td>
            <td>${(rec.version || '')}, ${(rec.selectedAgent || '')}</td>
            <td>${rec.refreshCount || 1}</td>
            <td>
              <button onclick="showMap(${parseFloat(rec.latitude) || 0}, ${parseFloat(rec.longitude) || 0})">
                Show Map
              </button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      recordsTable.innerHTML = html;
    }

    function showMap(lat, lng) {
      mapContainer.style.display = 'block';
      mapContainer.innerHTML = '';
      if (map) map.remove();

      map = L.map('map').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      L.marker([lat, lng]).addTo(map);
    }
  </script>
</body>
</html>
