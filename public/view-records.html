<!-- Alan UI - view-records.html | 19th June 2025, WJW -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Alan Records</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Alan Records: View and manage user records, history, and map locations for Alan's AI assistant."
    />
    <link rel="stylesheet" href="styles/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/png" href="favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="favicons/favicon-16x16.png" sizes="16x16" />
    <link rel="apple-touch-icon" href="favicons/apple-touch-icon.png" />
    <link rel="manifest" href="favicons/manifest.json" />
    <script type="module" src="scripts/faviconAndMeta.js" defer></script>
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
      /* Overall styling */
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: 'Calibri Light', Arial, sans-serif;
      }
      h1 {
        text-align: center;
        margin-top: 40px;
        font-size: 32px;
      }

      /* Password screen styling */
      .password-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 50px;
      }
      .password-row {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .password-column {
        display: flex;
        flex-direction: column;
        margin-right: 30px;
      }
      #passwordError {
        color: red;
        display: none;
        width: 220px;
        text-align: center;
        margin-top: 6px;
        margin-bottom: 0;
      }

      .hidden {
        display: none !important;
      }

      .container {
        padding: 0 20px;
      }

      /* Shared table styling for both active record and history tables */
      .records-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .records-table th,
      .records-table td {
        border: 1px solid black;
        padding: 10px;
        text-align: left;
        vertical-align: top;
      }
      .records-table th {
        background-color: #f2f2f2;
      }

      /* Red outline for the single active record row */
      tr.active-record {
        border: 2px solid red;
      }

      /* Refresh icon - increased size by 50% (from 30px to 45px) */
      .refresh-icon {
        cursor: pointer;
        font-size: 45px;
        display: inline-block;
        transition: transform 0.3s ease;
      }
      .refresh-icon:hover {
        transform: rotate(20deg);
      }
      .refresh-icon:active {
        transform: rotate(360deg);
      }

      /* Map container (initially hidden) */
      .map-container {
        width: 100%;
        height: 600px;
        margin-top: 20px;
        display: none;
      }
    </style>
  </head>

  <body>
    <header>
      <h1><span class="bold">Al</span><span class="light">an</span> Records</h1>
    </header>

    <main>
      <!-- PASSWORD SCREEN -->
      <div class="password-screen" id="passwordScreen">
        <h2 style="margin-bottom: 40px; font-weight: normal">
          Enter your <span style="font-weight: bold; color: red">Alan</span> password
        </h2>
        <div class="password-row">
          <div class="password-column">
            <input
              type="password"
              id="passwordInput"
              placeholder="Password"
              style="
                color: grey;
                padding: 12px;
                width: 220px;
                font-size: 16px;
                border-radius: 12px;
                border: 1px solid #ccc;
                margin-bottom: 20px;
              "
            />
            <p id="passwordError">Invalid password</p>
          </div>
          <button
            id="passwordSubmitBtn"
            disabled
            style="
              padding: 12px;
              font-size: 16px;
              border-radius: 12px;
              border: 1px solid #ccc;
              cursor: pointer;
              margin-top: -15px;
            "
          >
            Submit
          </button>
        </div>
      </div>
      <!-- END PASSWORD SCREEN -->

      <!-- REFRESH ICON (hidden until a valid password is entered) -->
      <div id="refreshContainer" class="hidden" style="text-align: center; margin-top: 20px">
        <span id="refreshIcon" class="refresh-icon">&#x21bb;</span>
      </div>

      <!-- MAIN CONTAINER -->
      <div class="container">
        <!-- DIV for the single active record (red box) -->
        <div id="activeRecordDiv" style="margin-top: 20px"></div>

        <!-- Heading + DIV for the full history -->
        <h3 id="historyTitle" style="display: none; margin-top: 40px">Full History</h3>
        <div id="historyDiv"></div>
      </div>

      <!-- MAP CONTAINER -->
      <div id="map" class="map-container"></div>
    </main>

    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
    <script>
      /* DOM References */
      const passwordScreen = document.getElementById('passwordScreen');
      const passwordInput = document.getElementById('passwordInput');
      const passwordError = document.getElementById('passwordError');
      const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');

      const refreshContainer = document.getElementById('refreshContainer');
      const refreshIcon = document.getElementById('refreshIcon');
      const activeRecordDiv = document.getElementById('activeRecordDiv');
      const historyTitle = document.getElementById('historyTitle');
      const historyDiv = document.getElementById('historyDiv');
      const mapContainer = document.getElementById('map');

      let currentPassword = '';
      let map; // Leaflet map instance
      let redIcon; // Declare redIcon here

      document.addEventListener('DOMContentLoaded', () => {
        // Define redIcon after DOM is ready, ensuring L (Leaflet) should be available
        redIcon = new L.Icon({
          iconUrl:
            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
          shadowUrl:
            'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        });

        passwordInput.addEventListener('input', handlePasswordInput);
        passwordInput.addEventListener('keypress', (evt) => {
          if (evt.key === 'Enter') handleSubmit();
        });
        passwordSubmitBtn.addEventListener('click', handleSubmit);

        refreshIcon.addEventListener('click', handleRefresh);
        attachMapButtonListeners(); // Call new function to attach listeners
      });

      function attachMapButtonListeners() {
        const mapButtons = document.querySelectorAll('.show-map-btn');
        mapButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const lat = parseFloat(button.dataset.lat);
            const lng = parseFloat(button.dataset.lng);
            showMap(lat, lng);
          });
        });
      }

      function handlePasswordInput() {
        passwordError.style.display = 'none';
        passwordSubmitBtn.disabled = passwordInput.value.trim() === '';
      }

      // Called when user clicks "Submit" on password screen
      function handleSubmit() {
        const entered = passwordInput.value.trim();
        // 1) Validate + fetch the single active record from /api/fetch-records
        fetch('/api/fetch-records', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: entered }),
        })
          .then((response) => {
            if (!response.ok) throw new Error('Invalid password');
            currentPassword = entered;
            passwordScreen.classList.add('hidden');
            return response.json();
          })
          .then((data) => {
            // data => single-element array
            showActiveRecord(data);
            refreshContainer.classList.remove('hidden');
            attachMapButtonListeners(); // Re-attach listeners after DOM update

            // 2) Also fetch full history from /fetch-history
            fetchHistory(currentPassword); // This will also call attachMapButtonListeners via showHistory
          })
          .catch((err) => {
            showInvalidPassword();
          });
      }

      function showInvalidPassword() {
        passwordError.style.display = 'block';
        passwordInput.value = '';
        passwordSubmitBtn.disabled = true;
        setTimeout(() => {
          passwordError.style.display = 'none';
        }, 3000);
      }

      function handleRefresh() {
        if (!currentPassword) {
          alert('No valid password found.');
          return;
        }
        // Re-fetch single active record
        fetchActiveRecord(currentPassword);
        // Re-fetch entire history
        fetchHistory(currentPassword);
      }

      function fetchActiveRecord(password) {
        fetch('/api/fetch-records', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        })
          .then((response) => {
            if (!response.ok) throw new Error('Invalid password');
            return response.json();
          })
          .then((data) => {
            showActiveRecord(data);
            attachMapButtonListeners(); // Re-attach listeners after DOM update
          })
          .catch((err) => {
            console.error('Error fetching single record:', err);
          });
      }

      function fetchHistory(password) {
        fetch('/api/fetch-history', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password }),
        })
          .then((response) => {
            if (!response.ok) throw new Error('Invalid password');
            return response.json();
          })
          .then((data) => {
            showHistory(data);
            attachMapButtonListeners(); // Re-attach listeners after DOM update
          })
          .catch((err) => {
            console.error('Error fetching history:', err);
          });
      }

      // Display the single active record
      function showActiveRecord(data) {
        if (!Array.isArray(data) || data.length === 0) {
          activeRecordDiv.innerHTML = '<p>No active record found.</p>';
          return;
        }
        const record = data[0];

        // Build the single-record table with a red border row
        activeRecordDiv.innerHTML = `
        <table class="records-table">
          <thead>
            <tr>
              <th>No.</th>
              <th>Session ID</th>
              <th>Name</th>
              <th>Role</th>
              <th>Experience</th>
              <th>Focus</th>
              <th>Contact</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Country (ISO2) [Classification]</th>
              <th>Area</th>
              <th>Date & Time</th>
              <th>Version & Agent</th>
              <th>Refresh Count</th>
              <th>Map</th>
            </tr>
          </thead>
          <tbody>
            <tr class="active-record">
              <td>1</td>
              <td>${record.sessionId || ''}</td>
              <td>${record.name || ''}</td>
              <td>${record.role || ''}</td>
              <td>${record.experience || ''}</td>
              <td>${Array.isArray(record.focus) ? record.focus.join(', ') : record.focus || ''}</td>
              <td>${record.contactInfo || ''}</td>
              <td>${record.latitude || ''}</td>
              <td>${record.longitude || ''}</td>
              <td>
                ${record.country || ''} (${record.iso2 || ''})
                [${record.classification || ''}]
              </td>
              <td>${record.area || ''}</td>
              <td>${record.dateTime || ''}</td>
              <td>${record.version || ''}, ${record.selectedAgent || ''}</td>
              <td>${record.refreshCount || 1}</td>
              <td>
                <button class="show-map-btn" data-lat="${parseFloat(record.latitude) || 0}" data-lng="${parseFloat(record.longitude) || 0}">
                  Show Map
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      `;
      }

      // Display the full history array
      function showHistory(historyArray) {
        if (!Array.isArray(historyArray) || historyArray.length === 0) {
          historyTitle.style.display = 'none';
          historyDiv.innerHTML = '<p>No historical records found.</p>';
          return;
        }

        // Show the heading
        historyTitle.style.display = 'block';

        // Build a table listing all records from user-history.json
        let html = `
        <table class="records-table">
          <thead>
            <tr>
              <th>No.</th>
              <th>Session ID</th>
              <th>Name</th>
              <th>Role</th>
              <th>Experience</th>
              <th>Focus</th>
              <th>Contact</th>
              <th>Latitude</th>
              <th>Longitude</th>
              <th>Country (ISO2) [Classification]</th>
              <th>Area</th>
              <th>Date & Time</th>
              <th>Version & Agent</th>
              <th>Refresh Count</th>
              <th>Map</th>
            </tr>
          </thead>
          <tbody>
      `;

        historyArray.forEach((rec, idx) => {
          html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${rec.sessionId || ''}</td>
            <td>${rec.name || ''}</td>
            <td>${rec.role || ''}</td>
            <td>${rec.experience || ''}</td>
            <td>${Array.isArray(rec.focus) ? rec.focus.join(', ') : rec.focus || ''}</td>
            <td>${rec.contactInfo || ''}</td>
            <td>${rec.latitude || ''}</td>
            <td>${rec.longitude || ''}</td>
            <td>
              ${rec.country || ''} (${rec.iso2 || ''})
              [${rec.classification || ''}]
            </td>
            <td>${rec.area || ''}</td>
            <td>${rec.dateTime || ''}</td>
            <td>${rec.version || ''}, ${rec.selectedAgent || ''}</td>
              <td>${rec.refreshCount || 1}</td>
              <td>
                <button class="show-map-btn" data-lat="${parseFloat(rec.latitude) || 0}" data-lng="${parseFloat(rec.longitude) || 0}">
                  Show Map
                </button>
              </td>
            </tr>
        `;
        });

        html += '</tbody></table>';
        historyDiv.innerHTML = html;
      }

      function showMap(lat, lng) {
        mapContainer.style.display = 'block';
        mapContainer.innerHTML = '';
        if (map) map.remove();

        map = L.map('map').setView([lat, lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);

        L.marker([lat, lng], { icon: redIcon }).addTo(map);
      }
    </script>
  </body>
</html>
