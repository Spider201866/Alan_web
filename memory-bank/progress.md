<!-- Alan UI - progress.md | Updated 6th February 2026, Codex -->

# Progress

This file tracks what works, what changed recently, and what's next.
Deep architecture details live in `systemPatterns.md` / `techContext.md`.

---

## Current Status (as of 12 Jan 2026)
- Stable, accessible PWA.
- Dev serves `public/`; prod serves `dist/` generated by `npm run build`.
- CI runs `npm test` (build + formatting + translations + a11y + jest).

## Current Status (as of 14 Jan 2026)
- Security posture strengthened (client-side injection hardening, additional headers, safer admin session cookies).
- Test suite expanded and made less noisy/brittle.

## Current Status (as of 6 Feb 2026)
- UI regression guardrails are now covered by dedicated tests (`layout-regressions` and `copy-regressions`).
- Documentation inventory (`folderList.txt`) and readmes (`README.md`, `tests/README.md`, `AGENTS.md`) were refreshed for consistency.
- Sitemap `lastmod` dates were updated to reflect current release timing.

---

## Recent Changes

### February 2026 Maintenance (6 Feb 2026)
- **Regression tests added**
  - Added `tests/ui/layout-regressions.test.js` for home top-gap and instructions mobile button-row regressions.
  - Added `tests/ui/copy-regressions.test.js` for `uvLightHeading` exact-value, instructions intro typo, and popup-close mojibake regressions.
- **Encoding corruption guardrail**
  - Extended `scripts/check-docs-sync.cjs` to fail on replacement-character corruption (`U+FFFD`) and common mojibake sequence bytes in tracked text files.
- **Content/date consistency updates**
  - Fixed `instructionsIntro` typo in `public/translations/en.json` (`learning`).
  - Updated `public/sitemap.xml` `lastmod` entries to `2026-02-06`.
  - Refreshed `README.md`, `tests/README.md`, `AGENTS.md`, and regenerated `folderList.txt`.
- **Validation**
  - Full gate `npm test`: pass (build + lint + format + translations + a11y + jest).
- **Docs/release workflow automation**
  - Added `scripts/sync-release-metadata.cjs` and npm script `sync:release-metadata`.
  - Added `scripts/check-docs-sync.cjs` and npm script `check:docs`.
  - `npm test` now includes `check:docs` so CI fails on docs drift.
  - Added `.gitattributes` for consistent line endings.

### February 2026 Maintenance (5 Feb 2026)
- **Shared exam page initializer**
  - Added `public/scripts/exam-page-init.js` to centralize section heading/body translation wiring for exam pages.
  - Refactored `public/scripts/eye.js`, `public/scripts/ear.js`, and `public/scripts/skin.js` to declarative config.
- **Language dropdown consistency**
  - Added `public/scripts/language-options.js` as canonical language option registry.
  - Updated home/index language controls to render options from this shared source.
- **Muted buttons fragment consolidation**
  - Added reusable partial `public/partials/muted-buttons.html`.
  - Added `mountMutedButtons()` in `public/scripts/muted.js`; updated home/muted page wiring to use the shared partial.
- **Index inline-style cleanup**
  - Removed multiple inline style attributes from `public/index.html`.
  - Added equivalent selectors in `public/styles/styles_index.css` for parity.
- **Validation**
  - `npm run lint`: pass.
  - `npm run check-translations`: pass.
  - `npm run test:ci`: pass (all suites green).

### January 2026 Maintenance (18 Jan 2026)
- **History ordering normalization**
  - Added `dateTimeEpoch` column to `history` for reliable SQL ordering and backfilled existing rows.
  - Client `record-info` payloads now send ISO timestamps; admin UI formats consistently.
- **Build pipeline reliability**
  - Build CSS minification now uses `clean-css` directly (no shell exec) and `scripts/build.js` exports `runBuild` for tests.
  - Fixed invalid referral priority option markup to keep HTML minification stable.
- **Admin allowlist middleware shared**
  - Extracted IP allowlist middleware to `middleware/admin-ip-allowlist.js` and reused in server and API routes.
- **Client record-info helper**
  - Centralized payload assembly and posting in `public/scripts/record-info.js`.

### January 2026 Maintenance (17 Jan 2026)
- **Centralised admin no-store headers**
  - Added `middleware/admin-no-store.js` and used it across admin endpoints and the admin page handler (`/view-records.html`).
- **Shared cookie parsing**
  - Added `utils/cookies.js` (`parseCookies`) and reused it for CSRF and admin session cookie handling.
- **CSRF hardening (double-submit cookie)**
  - CSRF middleware sets `csrf_token` cookie + `X-CSRF-Token` on safe methods and enforces `x-csrf-token` header match on mutating requests.
  - Admin CSRF fetch endpoint (`GET /api/admin/csrf`) returns token in JSON (when CSRF enabled) and uses the same no-store headers.
- **Flowise proxy hardening**
  - Proxy rejects absolute/`//` targets, strips sensitive headers, avoids aborting on normal completion, and supports streaming/SSE responses.
- **Frontend helpers + UX tweaks**
  - Added `public/scripts/sw-ready.js` (`whenSwReady`) with timeout fallback.
  - Added `public/scripts/storage.js` (standardised localStorage access + sessionId creation).
  - Added `public/scripts/csrf.js` helper (`withCsrfHeaders`) and updated client calls.
  - Mobile swipe-to-close for side menu + popup (touch gesture threshold) in `home-ui-handlers.js`.
  - Install button is hidden by default in CSS and only shown after `beforeinstallprompt` to prevent flashing.
- **Tests**
  - Updated/added tests for CSRF flows (`tests/api/validation.test.js`, `tests/api/admin-csrf.test.js`).

### January 2026 Maintenance (16 Jan 2026)
- **CSRF handling refinements + tests**
  - `/api/record-info` now validates request body before CSRF enforcement.
  - Global CSRF middleware skips `/api/record-info`; route applies CSRF per-route after validation.
  - Updated API tests to include CSRF cookie/header for `/api/record-info` and admin delete flows; formatted test file for Prettier.

### January 2026 Maintenance (14 Jan 2026)
- **Client-side injection hardening**
  - Introduced `public/scripts/trusted-html.js` for trusted markup insertion (sanitizes scripts, inline events, javascript: URLs; adds `rel` for `target=_blank`).
  - Replaced `innerHTML` usage for translations and UI injection where appropriate.
- **Admin hardening**
  - Admin session cookie TTL reduced to 15 minutes; production cookie name uses `__Host-` prefix.
  - Service worker bypasses `/api/*` caching.
- **Server hardening**
  - Added Permissions-Policy and additional low-risk security headers.
- **Testing improvements**
  - Added `tests/api/security-headers.test.js`.
  - `scripts/test-a11y.mjs` now stubs canvas context to avoid noisy warnings.
  - `tests/api/build.test.js` now checks for expected output files rather than brittle size comparisons.

### January 2026 Maintenance (11-12 Jan 2026)
- **Flowise proxy reliability**
  - Proxy is mounted early so request streams are readable.
  - Abort logic avoids aborting on normal request completion.
- **Environment-driven client logging**
  - Production builds inject `<meta name="alanui-env" content="production">`.
  - Client `log.js` uses this marker instead of hostname.
- **Build-stamped service worker cache name**
  - `scripts/build.js` stamps a unique cache name into `dist/service-worker.js`.
  - Removes need to manually bump `CACHE_NAME` per release.
- **CI/build hygiene**
  - Verbose build output gated behind `BUILD_DEBUG=true`.
  - CI made more resilient to dependency/a11y script dependency drift.

### January 2026 Developer Workflow Hygiene (12 Jan 2026)
- Added repo-level PowerShell guardrails:
  - `.clinerules/reminders.md` bans CMD-only syntax and documents PowerShell gotchas.
- Added a sanity skill:
  - `.clinerules/skills/powershell-sanity-checklist/SKILL.md`
    - Checks PowerShell basics, curl alias pitfalls, git metadata (`.git` vs `.git_disabled`).

---

## Backlog / Action Items (Prioritized)
1) **.gitignore hygiene**
   - Ensure local DBs (`alan-data.db`, `test-alan-data.db`) and `dist/` are ignored.
2) **(Optional) CSRF enablement in production**
   - `ENABLE_CSRF=true` and confirm client sends `x-csrf-token` for mutating requests.
3) **UX consistency**
   - Ensure a single handler path for the `instructions-button`.
4) **Docs hygiene**
   - Remove stale references (e.g. scripts referenced in older notes that no longer exist).
5) **(Optional) Consolidate SW_READY gating**
   - Prefer using `public/scripts/sw-ready.js` helper across pages to keep the SW_READY handshake consistent.

---

## What Works (Confirmed)
- PWA: offline fallback, caching strategies, install prompt handling.
- Accessibility: focus traps, skip links, translated content, keyboard navigation.
- Security: strict CSP, rate limiting, PBKDF2 auth, optional CSRF.
- Data: SQLite persistence with environment-specific DB path.
- Testing: Jest + JSDOM + API tests; a11y tests on built `dist/*.html`.

---

## Historical Notes (Archived)

<details>
<summary>September 2025 review (15 Sep 2025)</summary>

- Full codebase review performed (backend/frontend/PWA/build/tests).
- Confirmed orchestrator + modular frontend pattern.
- Confirmed service worker bypass for admin `view-records.html` and SW_READY handshake.
- Expanded Memory Bank to document confirmed patterns.

</details>

## 6 Feb 2026 - Production Home Top Gap Root Cause + Fix
- Root cause identified in production build output: minified HTML files contained `U+FEFF` between `<!doctype html>` and `<html>` (e.g., `dist/home.html`), which created a top line box (~19px) before `.page-container` on affected mobile Chrome.
- Build pipeline hardening added in `scripts/build.js`:
  - Strip `U+FEFF` when reading HTML files for patching.
  - Strip `U+FEFF` before writing patched HTML.
  - Strip `U+FEFF` before/after HTML minification writes.
- Verification:
  - Rebuilt `dist/` successfully (`npm run build`).
  - Confirmed `dist/home.html` and `dist/index.html` no longer contain `65279` between doctype and `<html>`.
  - Add regression check when needed:
    - Run character-code check at file start to ensure doctype is immediately followed by `<html>` with no `65279` in between.

<details>
<summary>July 2025 highlights</summary>

- Records page fixes (date display + CSP adjustments).
- Chat prompt marquee hiding reliability improvements.
- Screenshot functionality fix.
- Auth hashing alignment between generator and middleware.
- Image optimisation to WebP and on-demand loading improvements.

</details>
