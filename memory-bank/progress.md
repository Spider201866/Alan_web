<!-- Alan UI - progress.md | Updated 18th January 2026, Cline -->

# Progress

This file tracks what works, what changed recently, and what’s next.
Deep architecture details live in `systemPatterns.md` / `techContext.md`.

---

## Current Status (as of 12 Jan 2026)
- Stable, accessible PWA.
- Dev serves `public/`; prod serves `dist/` generated by `npm run build`.
- CI runs `npm test` (build + formatting + translations + a11y + jest).

## Current Status (as of 14 Jan 2026)
- Security posture strengthened (client-side injection hardening, additional headers, safer admin session cookies).
- Test suite expanded and made less noisy/brittle.

---

## Recent Changes

### January 2026 Maintenance (18 Jan 2026)
- **History ordering normalization**
  - Added `dateTimeEpoch` column to `history` for reliable SQL ordering and backfilled existing rows.
  - Client `record-info` payloads now send ISO timestamps; admin UI formats consistently.
- **Admin allowlist middleware shared**
  - Extracted IP allowlist middleware to `middleware/admin-ip-allowlist.js` and reused in server and API routes.
- **Client record-info helper**
  - Centralized payload assembly and posting in `public/scripts/record-info.js`.

### January 2026 Maintenance (17 Jan 2026)
- **Centralised admin no-store headers**
  - Added `middleware/admin-no-store.js` and used it across admin endpoints and the admin page handler (`/view-records.html`).
- **Shared cookie parsing**
  - Added `utils/cookies.js` (`parseCookies`) and reused it for CSRF and admin session cookie handling.
- **CSRF hardening (double-submit cookie)**
  - CSRF middleware sets `csrf_token` cookie + `X-CSRF-Token` on safe methods and enforces `x-csrf-token` header match on mutating requests.
  - Admin CSRF fetch endpoint (`GET /api/admin/csrf`) returns token in JSON (when CSRF enabled) and uses the same no-store headers.
- **Flowise proxy hardening**
  - Proxy rejects absolute/`//` targets, strips sensitive headers, avoids aborting on normal completion, and supports streaming/SSE responses.
- **Frontend helpers + UX tweaks**
  - Added `public/scripts/sw-ready.js` (`whenSwReady`) with timeout fallback.
  - Added `public/scripts/storage.js` (standardised localStorage access + sessionId creation).
  - Added `public/scripts/csrf.js` helper (`withCsrfHeaders`) and updated client calls.
  - Mobile swipe-to-close for side menu + popup (touch gesture threshold) in `home-ui-handlers.js`.
  - Install button is hidden by default in CSS and only shown after `beforeinstallprompt` to prevent flashing.
- **Tests**
  - Updated/added tests for CSRF flows (`tests/api/validation.test.js`, `tests/api/admin-csrf.test.js`).

### January 2026 Maintenance (16 Jan 2026)
- **CSRF handling refinements + tests**
  - `/api/record-info` now validates request body before CSRF enforcement.
  - Global CSRF middleware skips `/api/record-info`; route applies CSRF per-route after validation.
  - Updated API tests to include CSRF cookie/header for `/api/record-info` and admin delete flows; formatted test file for Prettier.

### January 2026 Maintenance (14 Jan 2026)
- **Client-side injection hardening**
  - Introduced `public/scripts/trusted-html.js` for *trusted* markup insertion (sanitizes scripts, inline events, javascript: URLs; adds rel for target=_blank).
  - Replaced `innerHTML` usage for translations and UI injection where appropriate.
- **Admin hardening**
  - Admin session cookie TTL reduced to 15 minutes; production cookie name uses `__Host-` prefix.
  - Service worker bypasses `/api/*` caching.
- **Server hardening**
  - Added Permissions-Policy and additional low-risk security headers.
- **Testing improvements**
  - Added `tests/api/security-headers.test.js`.
  - `scripts/test-a11y.mjs` now stubs canvas context to avoid noisy warnings.
  - `tests/api/build.test.js` now checks for expected output files rather than brittle size comparisons.

### January 2026 Maintenance (11–12 Jan 2026)
- **Flowise proxy reliability**
  - Proxy is mounted early so request streams are readable.
  - Abort logic avoids aborting on normal request completion.
- **Environment-driven client logging**
  - Production builds inject `<meta name="alanui-env" content="production">`.
  - Client `log.js` uses this marker instead of hostname.
- **Build-stamped service worker cache name**
  - `scripts/build.js` stamps a unique cache name into `dist/service-worker.js`.
  - Removes need to manually bump `CACHE_NAME` per release.
- **CI/build hygiene**
  - Verbose build output gated behind `BUILD_DEBUG=true`.
  - CI made more resilient to dependency/a11y script dependency drift.

### January 2026 Developer Workflow Hygiene (12 Jan 2026)
- Added repo-level PowerShell guardrails:
  - `.clinerules/reminders.md` bans CMD-only syntax and documents PowerShell gotchas.
- Added a sanity skill:
  - `.clinerules/skills/powershell-sanity-checklist/SKILL.md`
    - Checks PowerShell basics, curl alias pitfalls, git metadata (`.git` vs `.git_disabled`).

---

## Backlog / Action Items (Prioritized)
1) **.gitignore hygiene**
   - Ensure local DBs (`alan-data.db`, `test-alan-data.db`) and `dist/` are ignored.
2) **(Optional) CSRF enablement in production**
   - `ENABLE_CSRF=true` and confirm client sends `x-csrf-token` for mutating requests.
3) **UX consistency**
   - Ensure a single handler path for the `instructions-button`.
4) **Docs hygiene**
   - Remove stale references (e.g. scripts referenced in older notes that no longer exist).

5) **(Optional) Consolidate SW_READY gating**
   - Prefer using `public/scripts/sw-ready.js` helper across pages to keep the SW_READY handshake consistent.

---

## What Works (Confirmed)
- PWA: offline fallback, caching strategies, install prompt handling.
- Accessibility: focus traps, skip links, translated content, keyboard navigation.
- Security: strict CSP, rate limiting, PBKDF2 auth, optional CSRF.
- Data: SQLite persistence with environment-specific DB path.
- Testing: Jest + JSDOM + API tests; a11y tests on built `dist/*.html`.

---

## Historical Notes (Archived)

<details>
<summary>September 2025 review (15 Sep 2025)</summary>

- Full codebase review performed (backend/frontend/PWA/build/tests).
- Confirmed orchestrator + modular frontend pattern.
- Confirmed service worker bypass for admin `view-records.html` and SW_READY handshake.
- Expanded Memory Bank to document confirmed patterns.

</details>

<details>
<summary>July 2025 highlights</summary>

- Records page fixes (date display + CSP adjustments).
- Chat prompt marquee hiding reliability improvements.
- Screenshot functionality fix.
- Auth hashing alignment between generator and middleware.
- Image optimisation to WebP and on-demand loading improvements.

</details>
